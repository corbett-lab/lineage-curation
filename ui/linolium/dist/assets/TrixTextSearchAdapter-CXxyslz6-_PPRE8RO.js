import{s as y,a1 as C,be as v}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{e as O}from"./index-Bp4pXTEU-Cipcrd2k.js";import"./index-Bwk-R6QR.js";import"./taxonium-component.es-D8UFPkMd.js";var R=Object.defineProperty,S=(s,e,t)=>e in s?R(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,b=(s,e,t)=>S(s,typeof e!="symbol"?e+"":e,t);function j(s,e=JSON.stringify){const t=[],r=new Set;for(const i of s){const o=e(i);r.has(o)||(t.push(i),r.add(o))}return t}function k(s){let e=0;for(const t of s)e+=t.length;return e}function A(s){const e=new Uint8Array(k(s));let t=0;for(const r of s)e.set(r,t),t+=r.length;return e}const L=65536,B=10;class J{constructor(e,t,r=20){b(this,"ixxFile"),b(this,"ixFile"),b(this,"maxResults"),this.ixxFile=e,this.ixFile=t,this.maxResults=r}async search(e,t){let r=[];const i=e.split(" ")[0].toLowerCase(),o=await this._getBuffer(i,t);if(!o)return[];let{end:n,buffer:f}=o,c=!1;const m=new TextDecoder("utf8");for(;!c;){const l=m.decode(f),g=l.slice(0,l.lastIndexOf(`
`)).split(`
`).filter(a=>!!a),x=[];for(const a of g){const h=a.split(" ")[0],p=h.startsWith(i);h.slice(0,i.length)>i&&(c=!0),p&&x.push(a)}const d=x.flatMap(a=>{const[h,...p]=a.split(" ");return p.map(w=>[h,w.split(",")[0]])});if(r.length+d.length<this.maxResults&&!c){const a=await this.ixFile.read(L,n,t);if(a.length===0){r=r.concat(d);break}f=A([f,a]),n+=L}else if(r.length+d.length>=this.maxResults||c){r=r.concat(d);break}}return j(r,l=>l[1]).slice(0,this.maxResults)}async getIndex(e){return(await this.ixxFile.readFile({encoding:"utf8",...e})).split(`
`).filter(t=>!!t).map(t=>{const r=t.length-B,i=t.slice(0,r),o=t.slice(r),n=Number.parseInt(o,16);return[i,n]})}async _getBuffer(e,t){let r=0,i=65536;const o=await this.getIndex(t);for(const[f,c]of o)f.slice(0,e.length)<e&&(r=c,i=c+65536);const n=i-r;return n<0?void 0:{buffer:await this.ixFile.read(n,r,t),end:i}}}function I(s){try{return decodeURIComponent(s)}catch{return s}}function F(s,e,t=15){const r=s.toLowerCase().indexOf(e);return s.length<40?s:(Math.max(0,r-t)>0?"...":"")+s.slice(Math.max(0,r-t),r+e.length+t).trim()+(r+e.length<s.length?"...":"")}class T extends O.BaseAdapter{constructor(e,t,r){super(e,t,r);const i=y.readConfObject(e,"ixFilePath"),o=y.readConfObject(e,"ixxFilePath");if(!i)throw new Error("must provide out.ix");if(!o)throw new Error("must provide out.ixx");this.trixJs=new J(C.openLocation(o,r),C.openLocation(i,r),1500)}async searchIndex(e){const t=e.queryString.toLowerCase(),r=t.split(" "),i=(await this.trixJs.search(t)).filter(([,o])=>r.every(n=>I(o).toLowerCase().includes(n))).map(([o,n])=>{const f=JSON.parse(n.replaceAll("|",",")),[c,m,...l]=f.map(u=>I(u)),g=l.findIndex(u=>!!u),x=l.map(u=>u.toLowerCase()).findIndex(u=>u.includes(o.toLowerCase())),d=l[g],a=l[x],h=x!==-1?F(a,o):void 0,p=F(d,o),w=!h||p.toLowerCase()===h.toLowerCase()?p:`${p} (${h})`;return new v({locString:c,label:d,displayString:w,matchedObject:f.map(u=>decodeURIComponent(u)),trackId:m})});return e.searchType==="exact"?i.filter(o=>o.getLabel().toLowerCase()===e.queryString.toLowerCase()):i}}export{T as default};
