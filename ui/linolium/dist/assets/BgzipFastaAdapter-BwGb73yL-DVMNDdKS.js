import{x,b as y}from"./unzip-CwWdnRSo-02Ze3MCz.js";import{r as p}from"./browser-BpRiKmO--zAOSyNoU.js";import{a as z,I as _}from"./IndexedFastaAdapter-B4jpaRHL-BMcC7qys.js";import{a1 as d}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import"./index-CJFOLICt-oWu2Snlz.js";import"./taxonium-component.es-D8UFPkMd.js";import"./index-Bwk-R6QR.js";import"./AbortablePromiseCache-CcuMrnn7-56xRj2xE.js";import"./index-Bp4pXTEU-Cipcrd2k.js";import"./QuickLRU-Bsq1VS-k-DOcaC3o-.js";import"./rxjs-euq-mp90-DvajfGj-.js";const u=65536,I=u*u;function g(s,t=0){const a=s[t]|s[t+1]<<8|s[t+2]<<16|s[t+3]<<24;return((s[t+4]|s[t+5]<<8|s[t+6]<<16|s[t+7]<<24)>>>0)*I+(a>>>0)}const f=1;function m(s,t,a){const e=t[f],n=a?a[f]:1/0;return e<=s&&n>s?0:e<s?-1:1}class L{constructor({filehandle:t}){this.filehandle=t}_getIndex(){return this.index||(this.index=this._readIndex().catch(t=>{throw this.index=void 0,t})),this.index}async _readIndex(){const t=await this.filehandle.read(8,0),a=g(t);if(!a)return[[0,0]];const e=new Array(a+1);e[0]=[0,0];const n=16*a;if(n>Number.MAX_SAFE_INTEGER)throw new TypeError("integer overflow");const i=await this.filehandle.read(n,8);for(let r=0;r<a;r+=1){const h=g(i,r*16),o=g(i,r*16+8);e[r+1]=[h,o]}return e}async getLastBlock(){return(await this._getIndex()).at(-1)}async getRelevantBlocksForRead(t,a){const e=a+t;if(t===0)return[];const n=await this._getIndex(),i=[];let r=0,h=n.length-1,o=Math.floor(n.length/2),l=m(a,n[o],n[o+1]);for(;l!==0;)l>0?h=o-1:l<0&&(r=o+1),o=Math.ceil((h-r)/2)+r,l=m(a,n[o],n[o+1]);i.push(n[o]);let c=o+1;for(;c<n.length&&(i.push(n[c]),!(n[c][f]>=e));c+=1);return i[i.length-1][f]<e&&i.push([]),i}}class w{constructor({filehandle:t,gziFilehandle:a}){this.filehandle=t,this.gzi=new L({filehandle:a})}async _readAndUncompressBlock(t,a){let e=a;e||(e=(await this.filehandle.stat()).size);const n=e-t,i=await this.filehandle.read(n,t);return x(i)}async read(t,a){const e=await this.gzi.getRelevantBlocksForRead(t,a),n=[];for(let i=0;i<e.length-1;i+=1){const r=await this._readAndUncompressBlock(e[i][0],e[i+1][0]),[,h]=e[i],o=h>=a?0:a-h,l=Math.min(a+t,h+r.length)-h;o>=0&&o<r.length&&n.push(r.subarray(o,l))}return y(n)}}class M extends _{constructor({fasta:t,path:a,fai:e,faiPath:n,gzi:i,gziPath:r}){super({fasta:t,path:a,fai:e,faiPath:n}),t&&i?this.fasta=new w({filehandle:t,gziFilehandle:i}):a&&r&&(this.fasta=new w({filehandle:new p(a),gziFilehandle:new p(r)}))}}class T extends z{async setupPre(){const t=this.getConf("fastaLocation"),a=this.getConf("faiLocation"),e=this.getConf("gziLocation"),n={fasta:d.openLocation(t,this.pluginManager),fai:d.openLocation(a,this.pluginManager),gzi:d.openLocation(e,this.pluginManager)};return{fasta:new M(n)}}}export{T as default};
