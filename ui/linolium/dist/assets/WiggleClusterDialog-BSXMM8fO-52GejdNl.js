import{r as n,j as e}from"./index-Bwk-R6QR.js";import{o as L,a as A,u,D as F,B as l,T,c as E,O as P,d as O,t as D,j as I,m as N,aM as B,aN as X}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{E as z}from"./RadioGroup-o1e9QUFF-BonhG3v5.js";import{F as J}from"./FormControlLabel-t1db3bCW-BhUWxcLA.js";import{R as V}from"./Radio-Cp2Uq8Z1-VQbIOt0f.js";import"./taxonium-component.es-D8UFPkMd.js";const Y=L(function({model:t,children:o,handleClose:i}){const[p,h]=n.useState(""),[x,c]=n.useState(),[j,v]=n.useState(!1),[m,S]=n.useState(""),[g,f]=n.useState(!1),[w,k]=u.useLocalStorage("cluster-samplesPerPixel","1");return e.jsxs(e.Fragment,{children:[e.jsxs(F,{children:[o,e.jsxs("div",{style:{marginTop:50},children:[e.jsx(l,{variant:"contained",onClick:()=>{f(!g)},children:g?"Hide advanced options":"Show advanced options"}),g?e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(E,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:w,onChange:r=>{k(r.target.value)}})]}):null]}),e.jsxs("div",{children:[j?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:p||"Loading..."}),e.jsx(l,{onClick:()=>{P.stopStopToken(m)},children:"Stop"})]}):null,x?e.jsx(A.ErrorMessage,{error:x}):null]})]}),e.jsxs(O,{children:[e.jsx(l,{variant:"contained",disabled:j,onClick:async()=>{try{c(void 0),h("Initializing"),v(!0);const r=u.getContainingView(t);if(!r.initialized)return;const{rpcManager:C}=u.getSession(t),{sourcesWithoutLayout:y,adapterConfig:b}=t;if(y){const M=D.getRpcSessionId(t),s=P.createStopToken();S(s);const a=await C.call(M,"MultiWiggleClusterScoreMatrix",{regions:r.dynamicBlocks.contentBlocks,sources:y,sessionId:M,adapterConfig:b,stopToken:s,bpPerPx:r.bpPerPx/+w,statusCallback:d=>{h(d)}});t.setLayout(a.order.map(d=>{const R=y[d];if(!R)throw new Error(`out of bounds at ${d}`);return R}))}i()}catch(r){!u.isAbortException(r)&&I(t)&&(console.error(r),c(r))}finally{v(!1),h(""),S("")}},children:"Run clustering"}),e.jsx(l,{variant:"contained",color:"secondary",onClick:()=>{i(),m&&P.stopStopToken(m)},children:"Cancel"})]})]})}),Z=N()(t=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:t.spacing(4)}})),Q=L(function({model:t,handleClose:o,children:i}){const{classes:p}=Z(),[h,x]=n.useState(""),[c,j]=n.useState(),[v,m]=n.useState(),[S,g]=n.useState(!1),[f,w]=u.useLocalStorage("cluster-showAdvanced",!1),[k,r]=n.useState("single"),[C,y]=n.useState("1");n.useEffect(()=>{(async()=>{try{m(void 0),j(void 0),g(!0);const s=u.getContainingView(t),{dynamicBlocks:a,bpPerPx:d}=s,{rpcManager:R}=u.getSession(t),{sourcesWithoutLayout:q,adapterConfig:G}=t,$=D.getRpcSessionId(t),H=await R.call($,"MultiWiggleGetScoreMatrix",{regions:a.contentBlocks,sources:q,sessionId:$,adapterConfig:G,bpPerPx:d/+C});j(H)}catch(s){!u.isAbortException(s)&&I(t)&&(console.error(s),m(s))}finally{g(!1)}})()},[t,C]);const b=c?`inputMatrix<-matrix(c(${Object.values(c).map(s=>s.join(",")).join(`,
`)}
),nrow=${Object.values(c).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(c).map(s=>`'${s}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${k}')
cat(resultClusters$order,sep='\\n')`:void 0,M=c?Object.entries(c).map(([s,a])=>[s,...a].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(F,{children:[i,e.jsxs("div",{style:{marginTop:50},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(l,{variant:"contained",onClick:()=>{B.saveAs(new Blob([b||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(l,{variant:"contained",onClick:()=>{X(b||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(l,{variant:"contained",onClick:()=>{B.saveAs(new Blob([M||""],{type:"text/plain;charset=utf-8"}),"scores.tsv")},children:"Download TSV"})]}),e.jsx("div",{children:e.jsx(l,{variant:"contained",onClick:()=>{w(!f)},children:f?"Hide advanced options":"Show advanced options"})}),f?e.jsxs("div",{children:[e.jsx(T,{variant:"h6",children:"Advanced options"}),e.jsx(z,{children:Object.entries({single:"Single",complete:"Complete"}).map(([s,a])=>e.jsx(J,{control:e.jsx(V,{checked:k===s,onChange:()=>{r(s)}}),label:a},s))}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx(T,{children:"This procedure samples the data at each 'pixel' across the visible by default"}),e.jsx(E,{label:"Samples per pixel (>1 for denser sampling, between 0-1 for sparser sampling)",variant:"outlined",size:"small",value:C,onChange:s=>{y(s.target.value)}})]})]}):null,b?e.jsx("div",{}):S?e.jsx(A.LoadingEllipses,{variant:"h6",title:"Generating score matrix"}):v?e.jsx(A.ErrorMessage,{error:v}):null]}),e.jsxs("div",{children:[e.jsx(T,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(E,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:h,onChange:s=>{x(s.target.value)},slotProps:{input:{classes:{input:p.textAreaFont}}}})]})]})]}),e.jsxs(O,{children:[e.jsx(l,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:s}=t;if(s)try{t.setLayout(h.split(`
`).map(a=>a.trim()).filter(a=>!!a).map(a=>+a).map(a=>{const d=s[a-1];if(!d)throw new Error(`out of bounds at ${a}`);return d}))}catch(a){console.error(a),u.getSession(t).notifyError(`${a}`,a)}o()},children:"Apply clustering"}),e.jsx(l,{variant:"contained",color:"secondary",onClick:()=>{o()},children:"Cancel"})]})]})});function W({activeMode:t,setActiveMode:o}){return e.jsx("div",{children:e.jsx(z,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([i,p])=>e.jsx(J,{control:e.jsx(V,{checked:t===i,onChange:()=>{o(i)}}),label:p},i))})})}const ae=L(function({model:t,handleClose:o}){const[i,p]=n.useState("auto");return e.jsx(A.Dialog,{open:!0,title:"Cluster by score",maxWidth:"xl",onClose:(h,x)=>{x!=="backdropClick"&&o()},children:i==="auto"?e.jsx(Y,{model:t,handleClose:o,children:e.jsx(W,{activeMode:i,setActiveMode:p})}):e.jsx(Q,{model:t,handleClose:o,children:e.jsx(W,{activeMode:i,setActiveMode:p})})})});export{ae as default};
