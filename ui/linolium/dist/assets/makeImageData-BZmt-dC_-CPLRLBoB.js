import{s as H,a as z,u as w,bs as L,af as $,ah as G,J as F}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{e as j}from"./color-DgYUvRvM-B_LK-3Mw.js";import{N as J,E as Q}from"./getMethBins-DIAFukER-L3fr6GmJ.js";import"./index-Bwk-R6QR.js";import"./taxonium-component.es-D8UFPkMd.js";function V(e){return e.get("is_paired")&&e.get("refName")!==e.get("next_ref")?"#555":`hsl(${Math.abs(e.get("template_length"))/10},50%,50%)`}function Y(e){return`hsl(${e.get("score")},50%,50%)`}function U(e,f){const i=H.readConfObject(f,"orientationType"),d=F[i][e.get("pair_orientation")];return{LR:"color_pair_lr",RR:"color_pair_rr",RL:"color_pair_rl",LL:"color_pair_ll"}[d]}function Z(e){return e.get("strand")===-1?"#8F8FD8":"#EC8B8B"}function K(e,f){return j[U(e,f)||"color_nostrand"]}function ee(e){const f=e.get("flags"),i=e.get("strand");if(f&1){const d=f&64?-1:1;return f&2?i*d===1?"color_rev_strand":"color_fwd_strand":f&8?i*d===1?"color_rev_missing_mate":"color_fwd_missing_mate":e.get("refName")===e.get("next_ref")?i*d===1?"color_rev_strand_not_proper":"color_fwd_strand_not_proper":i===1?"color_fwd_diff_chr":"color_rev_diff_chr"}return"color_unknown"}function te(e){return j[ee(e)]}function oe({colorType:e,tag:f,feature:i,config:d,defaultColor:x,colorTagMap:a}){switch(e){case"insertSize":return V(i);case"strand":return Z(i);case"mappingQuality":return Y(i);case"pairOrientation":return K(i,d);case"stranded":return te(i);case"xs":case"tag":{const o=i.get("tags"),g=o?o[f]:i.get(f);return f==="XS"||f==="TS"?g==="-"?j.color_rev_strand:g==="+"?j.color_fwd_strand:j.color_nostrand:f==="ts"?g==="-"?i.get("strand")===-1?j.color_fwd_strand:j.color_rev_strand:g==="+"?i.get("strand")===-1?j.color_rev_strand:j.color_fwd_strand:j.color_nostrand:a[g]||j.color_nostrand}case"insertSizeAndPairOrientation":break;case"modifications":case"methylation":return i.get("flags")&16?"#c8dcc8":"#c8c8c8";default:return x?"lightgrey":H.readConfObject(d,"color",{feature:i})}}function ne({ctx:e,feat:f,renderArgs:i}){const{regions:d,bpPerPx:x}=i,{heightPx:a,topPx:o,feature:g}=f,p=d[0],m=g.get("start"),T=g.get("end"),b=g.get("CIGAR"),v=p.reversed?-1:1,P=g.get("strand")*v,u=x<10&&a>5;if(b!=null&&b.includes("N")){const h=L(b);if(P===1){let t=0,n=m;for(let l=0;l<h.length;l+=2){const s=+h[l],r=h[l+1];if(r==="M"||r==="X"||r==="="||r==="D")t+=s;else if(r==="N"){if(n!==t){const[_,C]=w.bpSpanPx(n,n+t,p,x),M=C-_;e.fillRect(_,o,M,a)}n+=t+s,t=0}}if(n!==t){const[l,s]=w.bpSpanPx(n,n+t,p,x),r=s-l;u?(e.beginPath(),e.moveTo(l,o),e.lineTo(l,o+a),e.lineTo(s,o+a),e.lineTo(s+5,o+a/2),e.lineTo(s,o),e.closePath(),e.fill()):e.fillRect(l,o,r,a)}}else if(P===-1){let t=0,n=T;for(let l=h.length-2;l>=0;l-=2){const s=+h[l],r=h[l+1];if(r==="M"||r==="X"||r==="="||r==="D")t+=s;else if(r==="N"){if(t!==0){const[_,C]=w.bpSpanPx(n-t,n,p,x);e.fillRect(_,o,C-_,a)}n-=t+s,t=0}}if(t!==0){const[l,s]=w.bpSpanPx(n-t,n,p,x),r=s-l;u?(e.beginPath(),e.moveTo(l-5,o+a/2),e.lineTo(l,o+a),e.lineTo(s,o+a),e.lineTo(s,o),e.lineTo(l,o),e.closePath(),e.fill()):e.fillRect(l,o,r,a)}}}else{const[h,t]=w.bpSpanPx(m,T,p,x);x<10&&a>5?P===-1?(e.beginPath(),e.moveTo(h-5,o+a/2),e.lineTo(h,o+a),e.lineTo(t,o+a),e.lineTo(t,o),e.lineTo(h,o),e.closePath(),e.fill()):(e.beginPath(),e.moveTo(h,o),e.lineTo(h,o+a),e.lineTo(t,o+a),e.lineTo(t+5,o+a/2),e.lineTo(t,o),e.closePath(),e.fill()):e.fillRect(h,o,t-h,a)}}function A(e,f,i,d,x,a,o){f+d<0||f>a||(o&&(e.fillStyle=o),e.fillRect(f,i,d,x))}function D(e){const{skip:f,deletion:i,insertion:d,hardclip:x,softclip:a,bases:o}=e.palette;return{A:o.A.main,C:o.C.main,G:o.G.main,T:o.T.main,deletion:i,insertion:d,hardclip:x,softclip:a,skip:f}}function re(e){return Object.fromEntries(Object.entries(D(e)).map(([f,i])=>[f,e.palette.getContrastText(i)]))}function ae(e){return["methylation","modifications"].includes(e||"")}function ie(){return!0}function X(){const e=w.measureText("A"),f=w.measureText("M")-2;return{charWidth:e,charHeight:f}}function le({ctx:e,feat:f,region:i,bpPerPx:d,renderArgs:x,canvasWidth:a,cigarOps:o}){var g,p,m;const{feature:T,topPx:b,heightPx:v}=f,{colorBy:P,visibleModifications:u={}}=x;if(!T.get("seq"))return;const h=T.get("start"),t=(g=P==null?void 0:P.modifications)===null||g===void 0?void 0:g.isolatedModification,n=(p=P==null?void 0:P.modifications)===null||p===void 0?void 0:p.twoColor;(m=Q(T,o))===null||m===void 0||m.forEach(({allProbs:l,prob:s,type:r},_)=>{const C=h+_,[M,W]=w.bpSpanPx(C,C+1,i,d),c=u[r];if(!c){console.warn(`${r} not known yet`);return}if(t&&c.type!==t)return;const O=c.color||"black",R=1-w.sum(l);if(n&&R>w.max(l)){const q=G("blue",R),S=W-M+.5;A(e,M,b,S,v,a,q)}else{const q=G(O,s),S=W-M+.5;A(e,M,b,S,v,a,q)}_++})}function se({ctx:e,feat:f,region:i,bpPerPx:d,colorMap:x,colorContrastMap:a,charWidth:o,charHeight:g,canvasWidth:p,cigarOps:m}){const T=g-2,{feature:b,topPx:v,heightPx:P}=f,u=b.get("seq"),h=1/d,t=b.get("start");let n=0,l=0;if(u)for(let s=0;s<m.length;s+=2){const r=+m[s],_=m[s+1];if(_==="S"||_==="I")n+=r;else if(_==="D"||_==="N")l+=r;else if(_==="M"||_==="X"||_==="="){for(let C=0;C<r;C++){const M=u[n+C],W=t+l+C,[c]=w.bpSpanPx(W,W+1,i,d),O=x[M];A(e,c,v,h+.5,P,p,O),h>=o&&P>=T&&(e.fillStyle=a[M],e.fillText(M,c+(h-o)/2+1,v+P))}n+=r,l+=r}}}function ce({ctx:e,feat:f,region:i,bpPerPx:d,canvasWidth:x,cigarOps:a}){const{feature:o,topPx:g,heightPx:p}=f,m=(o.get("qual")||"").split(" ").map(u=>+u),T=1/d,b=o.get("start");let v=0,P=0;for(let u=0;u<a.length;u+=2){const h=+a[u],t=a[u+1];if(t==="S"||t==="I")v+=h;else if(t==="D"||t==="N")P+=h;else if(t==="M"||t==="X"||t==="="){for(let n=0;n<h;n++){const l=m[v+n],s=b+P+n,r=w.bpSpanPx(s,s+1,i,d)[0],_=`hsl(${l===255?150:l*1.5},55%,50%)`;A(e,r,g,T+.5,p,x,_)}v+=h,P+=h}}}function fe({ctx:e,feat:f,region:i,bpPerPx:d,renderArgs:x,canvasWidth:a,cigarOps:o}){const{regionSequence:g}=x,{feature:p,topPx:m,heightPx:T}=f;if(!g)throw new Error("region sequence required for methylation");if(!p.get("seq"))return;const b=p.get("start"),v=p.get("end"),{methBins:P,methProbs:u,hydroxyMethBins:h,hydroxyMethProbs:t}=J(p,o);function n(s){if(P[s]){const r=u[s]||0;return(r>.5?$.colord("red").alpha((r-.5)*2):$.colord("blue").alpha(1-r*2)).toHslString()}if(h[s]){const r=t[s]||0;return(r>.5?$.colord("pink").alpha((r-.5)*2):$.colord("purple").alpha(1-r*2)).toHslString()}}const l=g.toLowerCase();for(let s=0;s<v-b;s++){const r=s+b,_=l[r-i.start+1],C=l[r-i.start+2];if(_==="c"&&C==="g")if(d>2){const[M,W]=w.bpSpanPx(r,r+2,i,d),c=W-M+.5,O=n(s)||n(s+1)||"blue";A(e,M,m,c,T,a,O)}else{const[M,W]=w.bpSpanPx(r,r+1,i,d),c=W-M+.5,O=n(s)||"blue";A(e,M,m,c,T,a,O);const[R,q]=w.bpSpanPx(r+1,r+2,i,d),S=q-R+.5,B=n(s+1)||"blue";A(e,R,m,S,T,a,B)}}}function de({ctx:e,feat:f,renderArgs:i,colorMap:d,colorContrastMap:x,charWidth:a,charHeight:o,defaultColor:g,canvasWidth:p}){const{config:m,bpPerPx:T,regions:b,colorBy:v,colorTagMap:P={}}=i,{tag:u="",type:h=""}=v||{},{feature:t}=f,n=b[0];switch(e.fillStyle=oe({feature:t,config:m,tag:u,defaultColor:g,colorType:h,colorTagMap:P}),ne({ctx:e,feat:f,renderArgs:i}),h){case"perBaseQuality":{const l=L(t.get("CIGAR"));ce({ctx:e,feat:f,region:n,bpPerPx:T,canvasWidth:p,cigarOps:l});break}case"perBaseLettering":{const l=L(t.get("CIGAR"));se({ctx:e,feat:f,region:n,bpPerPx:T,colorMap:d,colorContrastMap:x,charWidth:a,charHeight:o,canvasWidth:p,cigarOps:l});break}case"modifications":{const l=L(t.get("CIGAR"));le({ctx:e,feat:f,region:n,bpPerPx:T,renderArgs:i,canvasWidth:p,cigarOps:l});break}case"methylation":{const l=L(t.get("CIGAR"));fe({ctx:e,feat:f,region:n,bpPerPx:T,renderArgs:i,canvasWidth:p,cigarOps:l});break}}}function he({ctx:e,feat:f,renderArgs:i,minSubfeatureWidth:d,largeInsertionIndicatorScale:x,mismatchAlpha:a,charWidth:o,charHeight:g,colorMap:p,colorContrastMap:m,hideSmallIndels:T,canvasWidth:b,drawSNPsMuted:v,drawIndels:P=!0}){const{bpPerPx:u,regions:h}=i,{heightPx:t,topPx:n,feature:l}=f,s=h[0],r=l.get("start"),_=Math.min(1/u,2),C=l.get("mismatches"),M=g-2,W=s.reversed?1/u+1:-1;if(C){for(const c of C){const O=r+c.start,R=c.length,q=c.base,[S,B]=w.bpSpanPx(O,O+R,s,u),k=Math.max(d,B-S);if(c.type==="mismatch"){if(!v){const y=p[c.base]||"#888",N=a&&c.qual!==void 0?$.colord(y).alpha(Math.min(1,c.qual/50)).toHslString():y;A(e,Math.round(S),n,k,t,b,N)}if(k>=o&&t>=M){const y=v?"black":m[c.base]||"black";e.fillStyle=a&&c.qual!==void 0?$.colord(y).alpha(Math.min(1,c.qual/50)).toHslString():y,e.fillText(q,S+(k-o)/2+1,n+t)}}else if(c.type==="deletion"&&P){const y=c.length;if(!T||y>=10){A(e,S,n,Math.abs(S-B),t,b,p.deletion);const N=`${c.length}`,I=w.measureText(N,10);k>=I&&t>=M&&(e.fillStyle=m.deletion,e.fillText(N,(S+B)/2-I/2,n+t))}}else if(c.type==="insertion"&&P){const y=S+W,N=+c.base||c.length,I=Math.max(0,Math.min(1.2,1/u));if(N<10&&!T&&(A(e,y,n,I,t,b,p.insertion),1/u>=o&&t>=M)){const E=Math.round(y-I);A(e,E,n,I*3,1,b),A(e,E,n+t-1,I*3,1,b),e.fillText(`(${c.base})`,y+3,n+t)}}else if(c.type==="hardclip"||c.type==="softclip"){const y=S+W,N=p[c.type],I=Math.max(d,_);if(A(e,y,n,I,t,b,N),1/u>=o&&t>=M){const E=y-I;A(e,E,n,I*3,1,b),A(e,E,n+t-1,I*3,1,b),e.fillText(`(${c.base})`,y+3,n+t)}}else if(c.type==="skip"&&S+k>0){const y=k-(u>10?1.5:0),N=Math.max(0,S),I=n+t/2-1,E=y+Math.min(S,0);A(e,N,I,E,1,b,p.skip)}}if(P)for(const c of C){const O=r+c.start,R=c.length,q=+c.base||c.length;if(c.type==="insertion"&&q>=10){const[S]=w.bpSpanPx(O,O+R,s,u),B=`${q}`;if(u>x)A(e,S-1,n,2,t,b,p.insertion);else if(t>g){const k=w.measureText(B),y=5;A(e,S-k/2-y,n,k+2*y,t,b,"purple"),e.fillStyle=m.insertion,e.fillText(B,S-k/2,n+t)}else A(e,S-2,n,4,t,b,p.insertion)}}}}function pe({ctx:e,feat:f,renderArgs:i,config:d,theme:x,colorMap:a,canvasWidth:o}){const{feature:g,topPx:p,heightPx:m}=f,{regions:T,bpPerPx:b}=i,v=T[0],P=H.readConfObject(d,"minSubfeatureWidth"),u=g.get("mismatches"),h=g.get("seq"),{charWidth:t,charHeight:n}=X();if(!(h&&u))return;const l=n-2;let s=0,r=0;const _=g.get("CIGAR"),C=L(_);for(let M=0;M<C.length;M+=2){const W=C[M+1],c=+C[M];if(W==="S"){for(let O=0;O<c;O++){const R=h[s+O],q=g.get("start")-(M===0?c:0)+r+O,[S,B]=w.bpSpanPx(q,q+1,v,b),k=Math.max(P,B-S),y=a[R]||"#000000";e.fillStyle=y,A(e,S,p,k,m,o),k>=t&&m>=l&&(e.fillStyle=x.palette.getContrastText(y),e.fillText(R,S+(k-t)/2+1,p+m))}s+=c}W==="N"&&(r+=c),(W==="M"||W==="="||W==="X")&&(r+=c,s+=c),W==="D"&&(r+=c),W==="I"&&(s+=c)}}function Pe({ctx:e,layoutRecords:f,canvasWidth:i,renderArgs:d}){const{stopToken:x,config:a,showSoftClip:o,colorBy:g,theme:p}=d,m=H.readConfObject(a,"mismatchAlpha"),T=H.readConfObject(a,"minSubfeatureWidth"),b=H.readConfObject(a,"largeInsertionIndicatorScale"),v=H.readConfObject(a,"hideSmallIndels"),P=H.readConfObject(a,"color")==="#f0f",u=z.createJBrowseTheme(p),h=D(u),t=re(u);e.font="bold 10px Courier New,monospace";const{charWidth:n,charHeight:l}=X(),s=ae(g==null?void 0:g.type),r=ie();w.forEachWithStopTokenCheck(f,x,_=>{de({ctx:e,feat:_,renderArgs:d,defaultColor:P,colorMap:h,colorContrastMap:t,charWidth:n,charHeight:l,canvasWidth:i}),he({ctx:e,feat:_,renderArgs:d,hideSmallIndels:v,mismatchAlpha:m,drawSNPsMuted:s,drawIndels:r,largeInsertionIndicatorScale:b,minSubfeatureWidth:T,charWidth:n,charHeight:l,colorMap:h,colorContrastMap:t,canvasWidth:i}),o&&pe({ctx:e,feat:_,renderArgs:d,colorMap:h,config:a,theme:u,canvasWidth:i})})}export{Pe as makeImageData};
