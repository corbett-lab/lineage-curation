function m(l){return l.replaceAll(/%([0-9A-Fa-f]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}function g(l){if(!l.length||l===".")return{};const e={};return l.replace(/\r?\n$/,"").split(";").forEach(t=>{var s;const i=t.split("=",2);if(!(!((s=i[1])===null||s===void 0)&&s.length))return;i[0]=i[0].trim();let r=e[i[0].trim()];r||(r=[],e[i[0]]=r),r.push(...i[1].split(",").map(o=>o.trim()).map(m))}),e}function q(l){const e=l.split("	").map(t=>t==="."||t===""?null:t);return{seq_id:e[0]&&m(e[0]),source:e[1]&&m(e[1]),type:e[2]&&m(e[2]),start:e[3]===null?null:parseInt(e[3],10),end:e[4]===null?null:parseInt(e[4],10),score:e[5]===null?null:parseFloat(e[5]),strand:e[6],phase:e[7],attributes:e[8]===null?null:g(e[8])}}function A(l){var e,t;const s=/^\s*##\s*(\S+)\s*(.*)/.exec(l);if(!s)return null;const[,i]=s;let[,,r]=s;const o={directive:i};if(r.length&&(r=r.replace(/\r?\n$/,""),o.value=r),i==="sequence-region"){const n=r.split(/\s+/,3);return{...o,seq_id:n[0],start:(e=n[1])===null||e===void 0?void 0:e.replaceAll(/\D/g,""),end:(t=n[2])===null||t===void 0?void 0:t.replaceAll(/\D/g,"")}}else if(i==="genome-build"){const[n,a]=r.split(/\s+/,2);return{...o,source:n,buildName:a}}return o}const b={Parent:"child_features",Derives_from:"derived_features"};class k{constructor(e){this.seqCallback=e,this.currentSequence=void 0}addLine(e){const t=/^>\s*(\S+)\s*(.*)/.exec(e);t?(this._flush(),this.currentSequence={id:t[1],sequence:""},t[2]&&(this.currentSequence.description=t[2].trim())):this.currentSequence&&/\S/.test(e)&&(this.currentSequence.sequence+=e.replaceAll(/\s/g,""))}_flush(){this.currentSequence&&this.seqCallback(this.currentSequence)}finish(){this._flush()}}class D{constructor(e){this.fastaParser=void 0,this.eof=!1,this.lineNumber=0,this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},this._underConstructionOrphans={};const t=()=>{};this.featureCallback=e.featureCallback||t,this.endCallback=e.endCallback||t,this.commentCallback=e.commentCallback||t,this.errorCallback=e.errorCallback||t,this.directiveCallback=e.directiveCallback||t,this.sequenceCallback=e.sequenceCallback||t,this.disableDerivesFromReferences=e.disableDerivesFromReferences||!1,this.bufferSize=e.bufferSize===void 0?1e3:e.bufferSize}addLine(e){if(this.fastaParser){this.fastaParser.addLine(e);return}if(this.eof)return;if(this.lineNumber+=1,/^\s*[^#\s>]/.test(e)){this._bufferLine(e);return}const t=/^\s*(#+)(.*)/.exec(e);if(t){const[,s]=t;let[,,i]=t;if(s.length===3)this._emitAllUnderConstructionFeatures();else if(s.length===2){const r=A(e);r&&(r.directive==="FASTA"?(this._emitAllUnderConstructionFeatures(),this.eof=!0,this.fastaParser=new k(this.sequenceCallback)):this._emitItem(r))}else i=i.replace(/\s*/,""),this._emitItem({comment:i})}else if(!/^\s*$/.test(e))if(/^\s*>/.test(e))this._emitAllUnderConstructionFeatures(),this.eof=!0,this.fastaParser=new k(this.sequenceCallback),this.fastaParser.addLine(e);else{const s=e.replaceAll(/\r?\n?$/g,"");throw new Error(`GFF3 parse error.  Cannot parse '${s}'.`)}}finish(){this._emitAllUnderConstructionFeatures(),this.fastaParser&&this.fastaParser.finish(),this.endCallback()}_emitItem(e){Array.isArray(e)?this.featureCallback(e):"directive"in e?this.directiveCallback(e):"comment"in e&&this.commentCallback(e)}_enforceBufferSizeLimit(e=0){const t=s=>{var i,r;s&&Array.isArray(s)&&!((r=(i=s[0].attributes)===null||i===void 0?void 0:i.ID)===null||r===void 0)&&r[0]&&(s[0].attributes.ID.forEach(o=>{delete this._underConstructionById[o],delete this._completedReferences[o]}),s.forEach(o=>{o.child_features&&o.child_features.forEach(n=>t(n)),o.derived_features&&o.derived_features.forEach(n=>t(n))}))};for(;this._underConstructionTopLevel.length+e>this.bufferSize;){const s=this._underConstructionTopLevel.shift();s&&(this._emitItem(s),t(s))}}_emitAllUnderConstructionFeatures(){if(this._underConstructionTopLevel.forEach(this._emitItem.bind(this)),this._underConstructionTopLevel=[],this._underConstructionById={},this._completedReferences={},Array.from(Object.values(this._underConstructionOrphans)).length)throw new Error(`some features reference other features that do not exist in the file (or in the same '###' scope). ${Object.keys(this._underConstructionOrphans).join(",")}`)}_bufferLine(e){var t,s,i;const r={...q(e),child_features:[],derived_features:[]},o=((t=r.attributes)===null||t===void 0?void 0:t.ID)||[],n=((s=r.attributes)===null||s===void 0?void 0:s.Parent)||[],a=this.disableDerivesFromReferences?[]:((i=r.attributes)===null||i===void 0?void 0:i.Derives_from)||[];if(!o.length&&!n.length&&!a.length){this._emitItem([r]);return}let c;o.forEach(h=>{const u=this._underConstructionById[h];u?(u[u.length-1].type!==r.type&&this._parseError(`multi-line feature "${h}" has inconsistent types: "${r.type}", "${u[u.length-1].type}"`),u.push(r),c=u):(c=[r],this._enforceBufferSizeLimit(1),!n.length&&!a.length&&this._underConstructionTopLevel.push(c),this._underConstructionById[h]=c,this._resolveReferencesTo(c,h))}),this._resolveReferencesFrom(c||[r],{Parent:n,Derives_from:a},o)}_resolveReferencesTo(e,t){const s=this._underConstructionOrphans[t];s&&(e.forEach(i=>{i.child_features.push(...s.Parent)}),e.forEach(i=>{i.derived_features.push(...s.Derives_from)}),delete this._underConstructionOrphans[t])}_parseError(e){this.eof=!0,this.errorCallback(`${this.lineNumber}: ${e}`)}_resolveReferencesFrom(e,t,s){function i(r,o,n){let a=r[o];a||(a={},r[o]=a);const c=a[n]||!1;return a[n]=!0,c}t.Parent.forEach(r=>{const o=this._underConstructionById[r];if(o){const n=b.Parent;s.filter(a=>i(this._completedReferences,a,`Parent,${r}`)).length||o.forEach(a=>{a[n].push(e)})}else{let n=this._underConstructionOrphans[r];n||(n={Parent:[],Derives_from:[]},this._underConstructionOrphans[r]=n),n.Parent.push(e)}}),t.Derives_from.forEach(r=>{const o=this._underConstructionById[r];if(o){const n=b.Derives_from;s.filter(a=>i(this._completedReferences,a,`Derives_from,${r}`)).length||o.forEach(a=>{a[n].push(e)})}else{let n=this._underConstructionOrphans[r];n||(n={Parent:[],Derives_from:[]},this._underConstructionOrphans[r]=n),n.Derives_from.push(e)}})}}function I(l){const e=[],t=new D({featureCallback:s=>e.push(s),disableDerivesFromReferences:!0,errorCallback:s=>{throw s}});for(const s of l.split(/\r?\n/))t.addLine(s);return t.finish(),e}function S(l){const{end:e,start:t,child_features:s,derived_features:i,attributes:r,type:o,source:n,phase:a,seq_id:c,score:h,strand:u}=l;let p;u==="+"?p=1:u==="-"?p=-1:u==="."&&(p=0);const y=new Set(["start","end","seq_id","score","type","source","phase","strand"]),v=r||{},C={};for(const f of Object.keys(v)){let d=f.toLowerCase();if(y.has(d)&&(d+="2"),v[f]&&f!=="_lineHash"){let _=v[f];Array.isArray(_)&&_.length===1&&([_]=_),C[d]=_}}return{...C,start:t-1,end:e,strand:p,type:o,source:n,refName:c,derived_features:i,phase:a===null?void 0:Number(a),score:h===null?void 0:h,subfeatures:s.flatMap(f=>f.map(d=>S(d)))}}export{I as L,S as q};
