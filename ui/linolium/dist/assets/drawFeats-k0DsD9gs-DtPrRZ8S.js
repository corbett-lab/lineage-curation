import{u as A,l as $,s as O}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{p as V,u as L,d as U,l as j,e as q}from"./color-DgYUvRvM-B_LK-3Mw.js";import"./index-Bwk-R6QR.js";import"./taxonium-component.es-D8UFPkMd.js";function y(t,i,a,e,f,d){a<0&&(t+=a,a=-a),e<0&&(i+=e,e=-e),d&&(f.fillStyle=d),f.fillRect(t,i,a,e)}function z(t,i,a,e,f,d){a<0&&(t+=a,a=-a),e<0&&(i+=e,e=-e),d&&(f.strokeStyle=d),f.strokeRect(t,i,a,e)}function B({ctx:t,self:i,chainData:a,view:e,asm:f}){var d,m,M,p,b;const S=[],{chains:w}=a,{height:T}=i,v=O.getConf(i,"featureHeight");for(const N of w){let n=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const s of N){const r=f.getCanonicalRefName(s.refName)||s.refName,c=(d=e.bpToPx({refName:r,coord:s.start}))===null||d===void 0?void 0:d.offsetPx,l=(m=e.bpToPx({refName:r,coord:s.end}))===null||m===void 0?void 0:m.offsetPx;c!==void 0&&l!==void 0&&(n=Math.min(n,c),o=Math.max(o,l))}S.push({distance:Math.abs(o-n),minX:n,chain:N})}const R=S.map(N=>N.distance),E=Math.log(A.max(R)),_=Math.max(Math.log(A.min(R))-1,0),H=(T-20)/(E-_),D=v/2-.5;for(const{minX:N,distance:n,chain:o}of S){const s=n,r=(Math.log(s)-_)*H;y(N-e.offsetPx,r+D,s,1,t,"black");const c=o[0];let l;c.flags&2048?l=((M=c.SA)===null||M===void 0?void 0:M.split(";")[0].split(",")[2])==="-"?-1:1:l=c.strand;for(const x of o){const P=f.getCanonicalRefName(x.refName)||x.refName,u=(p=e.bpToPx({refName:P,coord:x.start}))===null||p===void 0?void 0:p.offsetPx,g=(b=e.bpToPx({refName:P,coord:x.end}))===null||b===void 0?void 0:b.offsetPx;if(u!==void 0&&g!==void 0){const C=Math.max(g-u,2),h=u-e.offsetPx,k=x.strand*l===-1?"color_rev_strand":"color_fwd_strand";z(h,r,C,v,t,j[k]),y(h,r,C,v,t,q[k])}}}}function F({ctx:t,self:i,chainData:a,view:e,asm:f}){var d,m,M,p,b,S,w;const T=[],v=O.getConf(i,"featureHeight"),R=((d=i.colorBy)===null||d===void 0?void 0:d.type)||"insertSizeAndOrientation",{chains:E,stats:_}=a;for(const n of E)if(n.length>1){const o=n[0],s=n[1],r=f.getCanonicalRefName(o.refName)||o.refName,c=f.getCanonicalRefName(s.refName)||s.refName,l=(m=e.bpToPx({refName:r,coord:o.start}))===null||m===void 0?void 0:m.offsetPx,x=(M=e.bpToPx({refName:r,coord:o.end}))===null||M===void 0?void 0:M.offsetPx,P=(p=e.bpToPx({refName:c,coord:s.start}))===null||p===void 0?void 0:p.offsetPx,u=(b=e.bpToPx({refName:c,coord:s.end}))===null||b===void 0?void 0:b.offsetPx;let g=0;if(l!==void 0&&x!==void 0&&P!==void 0&&u!==void 0){if(o.refName===s.refName){const C=Math.min(o.start,s.start),h=Math.max(o.end,s.end);g=Math.abs(h-C)}T.push({r1s:l,r1e:x,r2s:P,r2e:u,v0:o,v1:s,distance:g})}}else if(i.drawSingletons){const o=n[0],s=f.getCanonicalRefName(o.refName)||o.refName,r=(S=e.bpToPx({refName:s,coord:o.start}))===null||S===void 0?void 0:S.offsetPx,c=(w=e.bpToPx({refName:s,coord:o.end}))===null||w===void 0?void 0:w.offsetPx;if(r!==void 0&&c!==void 0){const l=Math.max(c-r,2);y(r-e.offsetPx,0,l,v,t,"#f00"),z(r-e.offsetPx,0,l,v,t,"#a00")}}const H=Math.log(A.max(T.map(n=>n.distance))),D=Math.max(Math.log(A.min(T.map(n=>n.distance)))-1,0),N=(i.height-20)/(H-D);for(const{r1e:n,r1s:o,r2e:s,r2s:r,distance:c,v0:l,v1:x}of T){const P=Math.max(n-o,2),u=Math.max(s-r,2),[g,C]=G({type:R,v0:l,v1:x,stats:_})||[],h=(Math.log(c)-D)*N,k=v/2-.5,X=r-n;y(n-e.offsetPx,h+k,X,1,t,"black"),z(o-e.offsetPx,h,P,v,t,C),z(r-e.offsetPx,h,u,v,t,C),y(o-e.offsetPx,h,P,v,t,g),y(r-e.offsetPx,h,u,v,t,g)}}function G({type:t,v0:i,v1:a,stats:e}){if(t==="insertSizeAndOrientation")return V(i,a,e);if(t==="orientation")return L(i);if(t==="insertSize")return U(i,a,e);if(t==="gradient"){const f=Math.min(i.start,a.start),d=Math.max(i.end,a.end);return[`hsl(${Math.log10(Math.abs(d-f))*10},50%,50%)`,`hsl(${Math.log10(Math.abs(d-f))*10},50%,30%)`]}}function K(t,i){const{chainData:a}=t;if(!a)return;const{assemblyManager:e}=A.getSession(t),f=A.getContainingView(t),d=f.assemblyNames[0],m=e.get(d);m&&($(a)?F({self:t,view:f,asm:m,ctx:i,chainData:a}):B({self:t,view:f,asm:m,ctx:i,chainData:a}))}export{K as drawFeats};
