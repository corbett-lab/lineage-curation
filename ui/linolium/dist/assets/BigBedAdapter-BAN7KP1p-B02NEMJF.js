import{P as U}from"./bbi-DEvpxuLy-BtN8_9V6.js";import{c as V}from"./AbortablePromiseCache-CcuMrnn7-56xRj2xE.js";import{$}from"./remoteFile-DvhH--az-9OF1arfw.js";import{w as D}from"./Observable-ztGTW3Os-DRs2VX0K.js";import{a1 as T,$ as B,a0 as A,u as I,aH as R}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{d as _,I as j}from"./merge-u3ffhOnq-DClX53QV.js";import{J as z,H as J}from"./util-DIF6WZFN-BRzR6C_J.js";import{e as L}from"./index-Bp4pXTEU-Cipcrd2k.js";import{o as M}from"./rxjs-euq-mp90-DvajfGj-.js";import"./browser-BpRiKmO--zAOSyNoU.js";import"./taxonium-component.es-D8UFPkMd.js";import"./index-Bwk-R6QR.js";function Y(P){return P.filter(e=>!!e)}class Q extends U{constructor(){super(...arguments),this.readIndicesCache=new V({cache:new $({maxSize:1}),fill:(e,r)=>this._readIndices({...e,signal:r})})}readIndices(e={}){const{signal:r,...t}=e;return this.readIndicesCache.get(JSON.stringify(t),e,r)}async getView(e,r){return this.getUnzoomedView(r)}async _readIndices(e){const{extHeaderOffset:r}=await this.getHeader(e),t=await this.bbi.read(64,Number(r)),n=new DataView(t.buffer,t.byteOffset,t.length);let i=0;i+=2;const c=n.getUint16(i,!0);i+=2;const o=Number(n.getBigUint64(i,!0));if(i+=8,c===0)return[];const w=20,k=w*c,x=await this.bbi.read(k,Number(o)),l=[];for(let S=0;S<c;S+=1){const m=x.subarray(S*w),N=new DataView(m.buffer,m.byteOffset,m.length);let a=0;const u=N.getInt16(a,!0);a+=2;const d=N.getInt16(a,!0);a+=2;const h=Number(N.getBigUint64(a,!0));a+=12;const g=N.getInt16(a,!0);l.push({type:u,fieldcount:d,offset:Number(h),field:g})}return l}async searchExtraIndexBlocks(e,r={}){const t=await this.readIndices(r);if(t.length===0)return[];const n=new TextDecoder("utf8"),i=t.map(async c=>{const{offset:o,field:w}=c,k=await this.bbi.read(32,o,r),x=new DataView(k.buffer,k.byteOffset,k.length);let l=0;l+=4;const S=x.getInt32(l,!0);l+=4;const m=x.getInt32(l,!0);l+=4;const N=x.getInt32(l,!0);l+=4,l+=8;const a=async u=>{const d=Number(u),h=4+S*(m+N),g=await this.bbi.read(h,d,r),b=new DataView(g.buffer,g.byteOffset,g.length);let s=0;const f=b.getInt8(s);s+=2;const p=b.getInt16(s,!0);s+=2;const q=[];if(f===0){const y=[];for(let E=0;E<p;E++){const F=n.decode(g.subarray(s,s+m)).replaceAll("\0","");s+=m;const C=Number(b.getBigUint64(s,!0));s+=8,y.push({key:F,offset:C})}let v=0;for(const{key:E,offset:F}of y){if(e.localeCompare(E)<0&&v)return a(v);v=F}return a(v)}else if(f===1){for(let y=0;y<p;y++){const v=n.decode(g.subarray(s,s+m)).replaceAll("\0","");s+=m;const E=Number(b.getBigUint64(s,!0));s+=8;const F=b.getUint32(s,!0);s+=4;const C=b.getUint32(s,!0);s+=4,q.push({key:v,offset:E,length:F,reserved:C})}for(const y of q)if(y.key===e)return{...y,field:w};return}};return a(o+32)});return Y(await Promise.all(i))}async searchExtraIndex(e,r={}){const t=await this.searchExtraIndexBlocks(e,r);if(t.length===0)return[];const n=await this.getUnzoomedView(r),i=t.map(c=>new D(o=>{n.readFeatures(o,[c],r).catch(w=>{o.error(w)})}).pipe(R((o,w)=>o.concat(w)),_(o=>{for(const w of o)w.field=c.field;return o})));return(await B(j(...i))).filter(c=>{var o;return((o=c.rest)==null?void 0:o.split("	")[(c.field||0)-3])===e})}}class fe extends L.BaseFeatureDataAdapter{async configurePre(e){const r=this.pluginManager,t=new Q({filehandle:T.openLocation(this.getConf("bigBedLocation"),r)}),n=await t.getHeader(e),i=new z({autoSql:n.autoSql});return{bigbed:t,header:n,parser:i}}async configure(e){return this.cachedP||(this.cachedP=this.configurePre(e).catch(r=>{throw this.cachedP=void 0,r})),this.cachedP}async getRefNames(e){const{header:r}=await this.configure(e);return Object.keys(r.refsByName)}async getRefNameAliases(e){const{header:r}=await this.configure(e);return(await Promise.all(Object.keys(r.refsByName).map(async t=>(await B(this.getFeatures({assemblyName:"",refName:t,start:0,end:1}).pipe(A())))[0]))).map(t=>t.toJSON()).map(t=>({refName:t.ucsc,aliases:[t.ncbi,t.refseq,t.genbank],override:!0}))}async getData(){const e=await this.getRefNames(),r=[];for(const t of e){const n=await B(this.getFeatures({assemblyName:"unknown",refName:t,start:0,end:Number.MAX_SAFE_INTEGER}).pipe(A()));r.push(n)}return r.flat()}async getHeader(e){const{parser:r,header:t}=await this.configure(e),{version:n,fileType:i}=t,{fields:c,...o}=r.autoSql;return{version:n,fileType:i,autoSql:o,fields:await this.getMetadata(e)}}async getMetadata(e){const{parser:r}=await this.configure(e),{fields:t}=r.autoSql;return Object.fromEntries(t.map(({name:n,comment:i})=>[n,i]))}async getFeaturesHelper({query:e,opts:r,observer:t,allowRedispatch:n,originalQuery:i=e}){const{statusCallback:c=()=>{}}=r,o=this.getConf("scoreColumn"),w=this.getConf("aggregateField"),{parser:k,bigbed:x}=await I.updateStatus("Downloading header",c,()=>this.configure(r)),l=await I.updateStatus("Downloading features",c,()=>x.getFeatures(e.refName,e.start,e.end,{basesPerSpan:e.end-e.start}));await I.updateStatus("Processing features",c,async()=>{var S;const m={},N=[];if(l.some(a=>a.uniqueId===void 0))throw new Error("found uniqueId undefined");for(const a of l){const u=[e.refName,`${a.start}`,`${a.end}`,...((S=a.rest)===null||S===void 0?void 0:S.split("	"))||[]],d=k.parseLine(u,{uniqueId:a.uniqueId}),h=d[w],g=h&&h!=="none";g&&!m[h]&&(m[h]=[]);const{uniqueId:b,type:s,chrom:f,chromStart:p,chromEnd:q,description:y,chromStarts:v,blockStarts:E,blockSizes:F,score:C,blockCount:G,thickStart:W,thickEnd:X,strand:K,...H}=d,O=J({...H,scoreColumn:o,splitLine:u,parser:k,uniqueId:b,start:a.start,end:a.end,refName:e.refName});g?(m[h].push(O),N.push(O)):I.doesIntersect2(O.start,O.end,i.start,i.end)&&t.next(new I.SimpleFeature({id:`${this.id}-${b}`,data:O}))}if(n&&N.length){let a=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY;for(const d of N)d.start<a&&(a=d.start),d.end>u&&(u=d.end);if(u>e.end||a<e.start){await this.getFeaturesHelper({query:{...e,start:a-5e5,end:u+5e5},opts:r,observer:t,allowRedispatch:!1,originalQuery:e});return}}Object.entries(m).map(([a,u])=>{var d,h,g;const b=I.min(u.map(f=>f.start)),s=I.max(u.map(f=>f.end));if(I.doesIntersect2(b,s,i.start,i.end)){const f=u.sort((p,q)=>p.uniqueId.localeCompare(q.uniqueId));if(f.some((p,q)=>f.some((y,v)=>q!==v&&I.doesIntersect2(p.start,p.end,y.start,y.end))))t.next(new I.SimpleFeature({id:`${this.id}-${(d=f[0])===null||d===void 0?void 0:d.uniqueId}-parent`,data:{type:"gene",subfeatures:f,strand:((h=f[0])===null||h===void 0?void 0:h.strand)||1,name:a,start:b,end:s,refName:e.refName}}));else for(const p of f)t.next(new I.SimpleFeature({id:`${this.id}-${p.uniqueId}-parent`,data:{type:"gene",subfeatures:[p],strand:((g=f[0])===null||g===void 0?void 0:g.strand)||1,name:a,start:p.start,end:p.end,refName:e.refName}}))}})}),t.complete()}getFeatures(e,r={}){return M.ObservableCreate(async t=>{try{await this.getFeaturesHelper({query:{...e,start:e.start,end:e.end},opts:r,observer:t,allowRedispatch:!0})}catch(n){t.error(n)}},r.stopToken)}}export{fe as default};
