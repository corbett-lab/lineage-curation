import{a as Re,ad as oe,ae as ne,s as W,u as j,ah as se,ai as xe}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import"./index-Bwk-R6QR.js";import"./taxonium-component.es-D8UFPkMd.js";const re=7,ie=4.5,Ne=7,ae={C:"G",G:"C",A:"T",T:"A"},_e=.6;async function Ge(e,le){var G;const{features:$,regions:ce,bpPerPx:P,colorBy:B,displayCrossHatches:fe,visibleModifications:z={},scaleOpts:F,height:he,theme:pe,config:w,ticks:de,stopToken:J}=le,ye=Re.createJBrowseTheme(pe),k=ce[0],be=(k.end-k.start)/P,A=xe,D=he-A*2,K={...F,range:[0,D]},ve=oe(K),ue=oe({...K,range:[0,D/2],scaleType:"linear"}),me=ne(F.scaleType),ge=ne("linear"),ke=W.readConfObject(w,"indicatorThreshold"),De=W.readConfObject(w,"showInterbaseCounts"),Te=W.readConfObject(w,"showArcs"),Se=W.readConfObject(w,"showInterbaseIndicators"),h=t=>D-(ve(t)||0)+A,T=t=>h(me)-h(t),L=t=>D-(ue(t)||0)+A,Q=t=>L(ge)-L(t),{bases:E,softclip:Ce,hardclip:Oe,insertion:Me}=ye.palette,S={A:E.A.main,C:E.C.main,G:E.G.main,T:E.T.main,insertion:Me,softclip:Ce,hardclip:Oe,total:W.readConfObject(w,"color"),mod_NONE:"blue",cpg_meth:"red",cpg_unmeth:"blue"};e.fillStyle=S.total,j.forEachWithStopTokenCheck($.values(),J,t=>{if(t.get("type")==="skip")return;const[y,m]=j.featureSpanPx(t,k,P),b=m-y+_e,p=t.get("score");e.fillRect(y,h(p),b,T(p))});let X=0;const ee=k.reversed?1/P:0,je=B.type==="modifications",Pe=B.type==="methylation",I=(G=B.modifications)===null||G===void 0?void 0:G.isolatedModification;if(j.forEachWithStopTokenCheck($.values(),J,t=>{var y,m,b,p,C,R,x,N,U;if(t.get("type")==="skip")return;const[v,we]=j.featureSpanPx(t,k,P),u=t.get("snpinfo"),_=Math.max(we-v,1),i=t.get("score");if(je){let a=0;const r=(y=u.refbase)===null||y===void 0?void 0:y.toUpperCase(),{nonmods:f,mods:c,snps:o,ref:n}=u;for(const l of Object.keys(f).sort().reverse()){const s=z[l.replace("nonmod_","")]||z[l.replace("mod_","")];if(!s){console.warn(`${l} not known yet`);continue}if(I&&s.type!==I)continue;const d=ae[s.base],q=s.base==="N"?i:(((m=o[s.base])===null||m===void 0?void 0:m.entryDepth)||0)+(((b=o[d])===null||b===void 0?void 0:b.entryDepth)||0)+(r===s.base?n[1]:0)+(r===d?n[-1]:0),H=s.base==="N"?i:(((p=o[s.base])===null||p===void 0?void 0:p.entryDepth)||0)+(((C=o[d])===null||C===void 0?void 0:C.entryDepth)||0)+(r===s.base?n.entryDepth:0)+(r===d?n.entryDepth:0),{entryDepth:V,avgProbability:Y=0}=u.nonmods[l],g=H/i*(V/q),Z=se("blue",Y),O=T(i),M=h(i)+O;e.fillStyle=Z,e.fillRect(Math.round(v),M-(a+g*O),_,g*O),a+=g*O}for(const l of Object.keys(c).sort().reverse()){const s=z[l.replace("mod_","")];if(!s){console.warn(`${l} not known yet`);continue}if(I&&s.type!==I)continue;const d=ae[s.base],q=s.base==="N"?i:(((R=o[s.base])===null||R===void 0?void 0:R.entryDepth)||0)+(((x=o[d])===null||x===void 0?void 0:x.entryDepth)||0)+(r===s.base?n[1]:0)+(r===d?n[-1]:0),H=s.base==="N"?i:(((N=o[s.base])===null||N===void 0?void 0:N.entryDepth)||0)+(((U=o[d])===null||U===void 0?void 0:U.entryDepth)||0)+(r===s.base?n.entryDepth:0)+(r===d?n.entryDepth:0),{entryDepth:V,avgProbability:Y=0}=c[l],g=H/i*(V/q),Z=s.color||"black",O=se(Z,Y),M=T(i),Ae=h(i)+M;e.fillStyle=O,e.fillRect(Math.round(v),Ae-(a+g*M),_,g*M),a+=g*M}}else if(Pe){const{depth:a,nonmods:r,mods:f}=u;let c=0;for(const o of Object.keys(f).sort().reverse()){const{entryDepth:n}=f[o],l=T(i),s=h(i)+l;e.fillStyle=S[o]||"black",e.fillRect(Math.round(v),s-(n+c)/a*l,_,n/a*l),c+=n}for(const o of Object.keys(r).sort().reverse()){const{entryDepth:n}=r[o],l=T(i),s=h(i)+l;e.fillStyle=S[o]||"black",e.fillRect(Math.round(v),s-(n+c)/a*l,_,n/a*l),c+=n}}else{const{depth:a,snps:r}=u;let f=0;for(const c of Object.keys(r).sort().reverse()){const{entryDepth:o}=r[c],n=T(i),l=h(i)+n;e.fillStyle=S[c]||"black",e.fillRect(Math.round(v),l-(o+f)/a*n,_,o/a*n),f+=o}}const te=Object.keys(u.noncov);if(De){let a=0;for(const r of te){const{entryDepth:f}=u.noncov[r],c=.6;e.fillStyle=S[r],e.fillRect(v-c+ee,ie+Q(a),c*2,Q(f)),a+=f}}if(Se){let a=0,r=0,f="";for(const o of te){const{entryDepth:n}=u.noncov[o];a+=n,n>r&&(r=n,f=o)}const c=Math.max(i,X);if(a>c*ke&&c>Ne){e.fillStyle=S[f],e.beginPath();const o=v+ee;e.moveTo(o-re/2,0),e.lineTo(o+re/2,0),e.lineTo(o,ie),e.fill()}}X=i}),Te&&j.forEachWithStopTokenCheck($.values(),J,t=>{if(t.get("type")!=="skip")return;const y=t.get("start"),m=t.get("end"),[b,p]=j.bpSpanPx(y,m,k,P);e.beginPath();const C=t.get("effectiveStrand"),R="rgba(255,200,200,0.7)",x="rgba(200,200,255,0.7)",N="rgba(200,200,200,0.7)";C===1?e.strokeStyle=R:C===-1?e.strokeStyle=x:e.strokeStyle=N,e.lineWidth=Math.log(t.get("score")+1),e.moveTo(b,D-A*2),e.bezierCurveTo(b,0,p,0,p,D-A*2),e.stroke()}),fe){e.lineWidth=1,e.strokeStyle="rgba(140,140,140,0.8)";for(const t of de.values)e.beginPath(),e.moveTo(0,Math.round(h(t))),e.lineTo(be,Math.round(h(t))),e.stroke()}}export{Ge as makeImage};
