import{y as A,$ as _}from"./remoteFile-DvhH--az-9OF1arfw.js";import{c as z}from"./AbortablePromiseCache-CcuMrnn7-56xRj2xE.js";import{Q as M}from"./taxonium-component.es-D8UFPkMd.js";import{e as q}from"./index-Bp4pXTEU-Cipcrd2k.js";import{o as O}from"./rxjs-euq-mp90-DvajfGj-.js";import{O as I}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import"./index-Bwk-R6QR.js";var N={exports:{}},j=N.exports,D;function B(){return D||(D=1,(function(w,t){(function(e,s){w.exports=s()})(j,(function(){const e=/^[\w+.-]+:\/\//,s=/^([\w+.-]+:)\/\/([^@/#?]*@)?([^:/#?]*)(:\d+)?(\/[^#?]*)?(\?[^#]*)?(#.*)?/,r=/^file:(?:\/\/((?![a-z]:)[^/#?]*)?)?(\/?[^#?]*)(\?[^#]*)?(#.*)?/i;function i(n){return e.test(n)}function a(n){return n.startsWith("//")}function c(n){return n.startsWith("/")}function u(n){return n.startsWith("file:")}function f(n){return/^[.?#]/.test(n)}function d(n){const h=s.exec(n);return g(h[1],h[2]||"",h[3],h[4]||"",h[5]||"/",h[6]||"",h[7]||"")}function m(n){const h=r.exec(n),o=h[2];return g("file:","",h[1]||"","",c(o)?o:"/"+o,h[3]||"",h[4]||"")}function g(n,h,o,p,b,l,F){return{scheme:n,user:h,host:o,port:p,path:b,query:l,hash:F,type:7}}function y(n){if(a(n)){const o=d("http:"+n);return o.scheme="",o.type=6,o}if(c(n)){const o=d("http://foo.com"+n);return o.scheme="",o.host="",o.type=5,o}if(u(n))return m(n);if(i(n))return d(n);const h=d("http://foo.com/"+n);return h.scheme="",h.host="",h.type=n?n.startsWith("?")?3:n.startsWith("#")?2:4:1,h}function v(n){if(n.endsWith("/.."))return n;const h=n.lastIndexOf("/");return n.slice(0,h+1)}function x(n,h){L(h,h.type),n.path==="/"?n.path=h.path:n.path=v(h.path)+n.path}function L(n,h){const o=h<=4,p=n.path.split("/");let b=1,l=0,F=!1;for(let k=1;k<p.length;k++){const T=p[k];if(!T){F=!0;continue}if(F=!1,T!=="."){if(T===".."){l?(F=!0,l--,b--):o&&(p[b++]=T);continue}p[b++]=T,l++}}let C="";for(let k=1;k<b;k++)C+="/"+p[k];(!C||F&&!C.endsWith("/.."))&&(C+="/"),n.path=C}function U(n,h){if(!n&&!h)return"";const o=y(n);let p=o.type;if(h&&p!==7){const l=y(h),F=l.type;switch(p){case 1:o.hash=l.hash;case 2:o.query=l.query;case 3:case 4:x(o,l);case 5:o.user=l.user,o.host=l.host,o.port=l.port;case 6:o.scheme=l.scheme}F>p&&(p=F)}L(o,p);const b=o.query+o.hash;switch(p){case 2:case 3:return b;case 4:{const l=o.path.slice(1);return l?f(h||n)&&!f(l)?"./"+l+b:l+b:b||"."}case 5:return o.path+b;default:return o.scheme+"//"+o.user+o.host+o.port+o.path+b}}return U}))})(N)),N.exports}var $=B();const J=M($);async function E(w,t,e={}){const{defaultContent:s={}}=e;try{const r=await t(w,{encoding:"utf8"}),i=new TextDecoder("utf8");return JSON.parse(i.decode(r))}catch(r){if(r.code==="ENOENT"||r.status===404||r.message.includes("404")||r.message.includes("ENOENT"))return s;throw r}}function R(w,t="."){return J(w,t)}class P{constructor({readFile:t,cacheSize:e=100}){if(this.topList=[],this.chunkCache=new z({cache:new _({maxSize:e}),fill:this.readChunkItems.bind(this)}),this.readFile=t,!this.readFile)throw new Error('must provide a "readFile" function')}importExisting(t,e,s,r,i){this.topList=t,this.attrs=e,this.start=e.makeFastGetter("Start"),this.end=e.makeFastGetter("End"),this.lazyClass=i,this.baseURL=s,this.lazyUrlTemplate=r}binarySearch(t,e,s){let r=-1,i=t.length,a;for(;i-r>1;)a=r+i>>>1,s(t[a])>=e?i=a:r=a;return s===this.end?i:r}readChunkItems(t){const e=R(this.lazyUrlTemplate.replaceAll(/\{Chunk\}/gi,t),this.baseURL);return E(e,this.readFile,{defaultContent:[]})}async*iterateSublist(t,e,s,r,i,a,c){const u=this.attrs.makeGetter("Chunk"),f=this.attrs.makeGetter("Sublist"),d=[];for(let m=this.binarySearch(t,e,i);m<t.length&&m>=0&&r*a(t[m])<r*s;m+=r){if(t[m][0]===this.lazyClass){const y=u(t[m]),v=this.chunkCache.get(y,y).then(x=>[x,y]);d.push(v)}else yield[t[m],c.concat(m)];const g=f(t[m]);g&&(yield*this.iterateSublist(g,e,s,r,i,a,c.concat(m)))}for(const m of d){const[g,y]=await m;g&&(yield*this.iterateSublist(g,e,s,r,i,a,[...c,y]))}}async*iterate(t,e){const s=t>e?-1:1,r=t>e?this.start:this.end,i=t>e?this.end:this.start;this.topList.length>0&&(yield*this.iterateSublist(this.topList,t,e,s,r,i,[0]))}async histogram(t,e,s){const r=new Array(s);r.fill(0);const i=(e-t)/s;for await(const a of this.iterate(t,e)){const c=Math.max(0,(this.start(a)-t)/i|0),u=Math.min(s,(this.end(a)-t)/i|0);for(let f=c;f<=u;f+=1)r[f]+=1}return r}}class W{constructor(t){this.classes=t,this.fields=[];for(let e=0;e<t.length;e+=1){this.fields[e]={};for(let s=0;s<t[e].attributes.length;s+=1)this.fields[e][t[e].attributes[s]]=s+1;t[e].proto===void 0&&(t[e].proto={}),t[e].isArrayAttr===void 0&&(t[e].isArrayAttr={})}}attrIndices(t){return this.classes.map(e=>e.attributes.indexOf(t)+1||e.attributes.indexOf(t.toLowerCase())+1||void 0)}get(t,e){if(e in this.fields[t[0]])return t[this.fields[t[0]][e]];const s=e.toLowerCase();if(s in this.fields[t[0]])return t[this.fields[t[0]][s]];const r=this.classes[t[0]].attributes.length+1;return r>=t.length||!(e in t[r])?e in this.classes[t[0]].proto?this.classes[t[0]].proto[e]:void 0:t[r][e]}makeSetter(t){return(e,s)=>{this.set(e,t,s)}}makeGetter(t){return e=>this.get(e,t)}makeFastGetter(t){const e=this.attrIndices(t);return function(s){if(e[s[0]]!==void 0)return s[e[s[0]]]}}accessors(){return this._accessors||(this._accessors=this._makeAccessors()),this._accessors}_makeAccessors(){const t={},e={get(r){const i=this.get.field_accessors[r.toLowerCase()];if(i)return i.call(this)},set(r,i){const a=this.set.field_accessors[r];if(a)return a.call(this,i)},tags(){return s[this[0]]||[]}};e.get.field_accessors={},e.set.field_accessors={},this.classes.forEach((r,i)=>{(r.attributes||[]).forEach((a,c)=>{t[a]=t[a]||[],t[a][i]=c+1,a=a.toLowerCase(),t[a]=t[a]||[],t[a][i]=c+1})});const s=this.classes.map(r=>r.attributes);return Object.keys(t).forEach(r=>{const i=t[r];e.get.field_accessors[r]=i?function(){return this[i[this[0]]]}:function(){}}),e}}class G{constructor({urlTemplate:t,chunkSize:e,length:s,cacheSize:r=100,readFile:i},a){if(this.urlTemplate=t,this.chunkSize=e,this.length=s,this.baseUrl=a===void 0?"":a,this.readFile=i,!i)throw new Error("must provide readFile callback");this.chunkCache=new z({cache:new _({maxSize:r}),fill:this.getChunk.bind(this)})}index(t,e,s){this.range(t,t,e,void 0,s)}async*range(t,e){t=Math.max(0,t),e=Math.min(e,this.length-1);const s=Math.floor(t/this.chunkSize),r=Math.floor(e/this.chunkSize),i=[];for(let a=s;a<=r;a+=1)i.push(this.chunkCache.get(a,a));for(const a of i){const[c,u]=await a;yield*this.filterChunkData(t,e,c,u)}}async getChunk(t){let e=this.urlTemplate.replaceAll(/\{Chunk\}/gi,t);this.baseUrl&&(e=R(e,this.baseUrl));const s=await E(e,this.readFile);return[t,s]}*filterChunkData(t,e,s,r){const i=s*this.chunkSize,a=Math.max(0,t-i),c=Math.min(e-i,this.chunkSize-1);for(let u=a;u<=c;u+=1)yield[u+i,r[u]]}}function H(){return this._uniqueID}function Q(){return this._parent}function K(){return this.get("subfeatures")}class V{constructor({baseUrl:t,urlTemplate:e,readFile:s,cacheSize:r=10}){if(this.baseUrl=t,this.urlTemplates={root:e},this.readFile=s,!this.readFile)throw new Error('must provide a "readFile" function argument');this.dataRootCache=new z({cache:new _({maxSize:r}),fill:this.fetchDataRoot.bind(this)})}makeNCList(){return new P({readFile:this.readFile})}loadNCList(t,e,s){t.nclist.importExisting(e.intervals.nclist,t.attrs,s,e.intervals.urlTemplate,e.intervals.lazyClass)}getDataRoot(t){return this.dataRootCache.get(t,t)}fetchDataRoot(t){const e=R(this.urlTemplates.root.replaceAll(/{\s*refseq\s*}/g,t),this.baseUrl);return E(e,this.readFile).then(s=>this.parseTrackInfo(s,e))}parseTrackInfo(t,e){const s={nclist:this.makeNCList(),stats:{featureCount:t.featureCount||0}};t.intervals&&(s.attrs=new W(t.intervals.classes),this.loadNCList(s,t,e));const{histograms:r}=t;if(r!=null&&r.meta){for(let i=0;i<r.meta.length;i+=1)r.meta[i].lazyArray=new G({...r.meta[i].arrayParams,readFile:this.readFile},e);s._histograms=r}return s._histograms&&Object.keys(s._histograms).forEach(i=>{s._histograms[i].forEach(a=>{Object.keys(a).forEach(c=>{typeof a[c]=="string"&&String(Number(a[c]))===a[c]&&(a[c]=Number(a[c]))})})}),s}async getRegionStats(t){return(await this.getDataRoot(t.ref)).stats}async getRegionFeatureDensities({refName:t,start:e,end:s,numBins:r,basesPerBin:i}){const a=await this.getDataRoot(t);if(r)i=(s-e)/r;else if(i)r=Math.ceil((s-e)/i);else throw new TypeError("numBins or basesPerBin arg required for getRegionFeatureDensities");const c=(a._histograms.stats||[]).find(d=>d.basesPerBin>=i);let u=a._histograms.meta[0];for(let d=0;d<a._histograms.meta.length;d+=1)i>=a._histograms.meta[d].basesPerBin&&(u=a._histograms.meta[d]);let f=i/u.basesPerBin;if(f>.9&&Math.abs(f-Math.round(f))<1e-4){const d=Math.floor(e/u.basesPerBin);f=Math.round(f);const m=[];for(let g=0;g<r;g+=1)m[g]=0;for await(const[g,y]of u.lazyArray.range(d,d+f*r-1))m[Math.floor((g-d)/f)]+=y;return{bins:m,stats:c}}return{bins:await a.nclist.histogram(e,s,r),stats:c}}async*getFeatures({refName:t,start:e,end:s}){var r;const i=await this.getDataRoot(t),a=(r=i.attrs)==null?void 0:r.accessors();for await(const[c,u]of i.nclist.iterate(e,s)){if(!c.decorated){const f=u.join(",");this.decorateFeature(a,c,`${t},${f}`)}yield c}}decorateFeature(t,e,s,r){e.get=t.get,e.tags=t.tags,e._uniqueID=s,e.id=H,e._parent=r,e.parent=Q,e.children=K,(e.get("subfeatures")||[]).forEach((i,a)=>{this.decorateFeature(t,i,`${s}-${a}`,e)}),e.decorated=!0}}const X={refName:"seq_id"},Y={seq_id:"refName"};class S{constructor(t,e,s){this.ncFeature=t,this.uniqueId=s||t.id(),this.parentHandle=e}set(){throw new Error("not implemented")}jb2TagToJb1Tag(t){return(X[t]||t).toLowerCase()}jb1TagToJb2Tag(t){const e=t.toLowerCase();return Y[e]||e}get(t){const e=this.ncFeature.get(this.jb2TagToJb1Tag(t));return e&&t==="subfeatures"?e.map(s=>new S(s,this)):e}tags(){return this.ncFeature.tags().map(t=>this.jb1TagToJb2Tag(t))}id(){return this.uniqueId}parent(){return this.parentHandle}children(){return this.get("subfeatures")}toJSON(){const t={uniqueId:this.id()};for(const e of this.ncFeature.tags()){const s=this.jb1TagToJb2Tag(e),r=this.ncFeature.get(e);s==="subfeatures"?t.subfeatures=(r||[]).map(i=>new S(i,this).toJSON()):t[s]=r}return t}}class nt extends q.BaseFeatureDataAdapter{constructor(t,e,s){super(t,e,s);const r=this.getConf("refNames"),i=this.getConf("rootUrlTemplate");this.configRefNames=r,this.nclist=new V({baseUrl:"",urlTemplate:i.uri,readFile:a=>new A(String(i.baseUri?new URL(a,i.baseUri).toString():a)).readFile()})}getFeatures(t,e={}){return O.ObservableCreate(async s=>{const{stopToken:r}=e;for await(const i of this.nclist.getFeatures(t,e))I.checkStopToken(r),s.next(this.wrapFeature(i));s.complete()})}wrapFeature(t){return new S(t,void 0,`${this.id}-${t.id()}`)}async hasDataForRefName(t){var e;const s=await this.nclist.getDataRoot(t);return!!(!((e=s==null?void 0:s.stats)===null||e===void 0)&&e.featureCount)}async getRefNames(){return this.configRefNames||[]}}export{nt as default};
