import{y as q,$ as Y}from"./remoteFile-DvhH--az-9OF1arfw.js";import{x as $,_ as et}from"./unzip-CwWdnRSo-02Ze3MCz.js";import{c as nt}from"./crc32-CxoSWZf_-CJxmRem5.js";import{r as k}from"./browser-BpRiKmO--zAOSyNoU.js";import{e as st}from"./index-Bp4pXTEU-Cipcrd2k.js";import{a1 as U,u as N,$ as rt,a0 as it,O as z,bW as ot,bX as at,bU as ht,bV as W}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{s as ct}from"./QuickLRU-Bsq1VS-k-DOcaC3o-.js";import{o as ut}from"./rxjs-euq-mp90-DvajfGj-.js";import"./taxonium-component.es-D8UFPkMd.js";import"./index-Bwk-R6QR.js";import"./index-CJFOLICt-oWu2Snlz.js";class L{constructor(t,e,n,s){this.minv=t,this.maxv=e,this.bin=n,this._fetchedSize=s}toUniqueString(){return`${this.minv.toString()}..${this.maxv.toString()} (bin ${this.bin}, fetchedSize ${this.fetchedSize()})`}toString(){return this.toUniqueString()}compareTo(t){return this.minv.compareTo(t.minv)||this.maxv.compareTo(t.maxv)||this.bin-t.bin}fetchedSize(){return this._fetchedSize!==void 0?this._fetchedSize:this.maxv.blockPosition+65536-this.minv.blockPosition}}class Q{constructor({filehandle:t,renameRefSeq:e=n=>n}){this.filehandle=t,this.renameRefSeq=e}}const V=65536,ft=V*V;function lt(o,t=0){const e=o[t]|o[t+1]<<8|o[t+2]<<16|o[t+3]<<24;return((o[t+4]|o[t+5]<<8|o[t+6]<<16|o[t+7]<<24)>>>0)*ft+(e>>>0)}function dt(o){return new Promise(t=>setTimeout(t,o))}function gt(o){if(o&&o.aborted)if(typeof DOMException>"u"){const t=new Error("aborted");throw t.code="ERR_ABORTED",t}else throw new DOMException("aborted","AbortError")}function mt(o,t){return t.minv.blockPosition-o.maxv.blockPosition<65e3&&t.maxv.blockPosition-o.minv.blockPosition<5e6}function pt(o={}){return"aborted"in o?{signal:o}:o}function J(o,t){const e=[];let n;if(o.length===0)return o;o.sort((s,r)=>{const i=s.minv.blockPosition-r.minv.blockPosition;return i===0?s.minv.dataPosition-r.minv.dataPosition:i});for(const s of o)(!t||s.maxv.compareTo(t)>0)&&(n===void 0?(e.push(s),n=s):mt(n,s)?s.maxv.compareTo(n.maxv)>0&&(n.maxv=s.maxv):(e.push(s),n=s));return e}function X(o,t){return{lineCount:lt(o,t)}}function T(o,t){return o?o.compareTo(t)>0?t:o:t}function bt(o,t=e=>e){let e=0,n=0;const s=[],r={};for(let i=0;i<o.length;i+=1)if(!o[i]){if(n<i){let a="";for(let h=n;h<i;h++)a+=String.fromCharCode(o[h]);a=t(a),s[e]=a,r[a]=e}n=i+1,e+=1}return{refNameToId:r,refIdToName:s}}function wt(o){let t=0;for(const e of o)t+=e.length;return t}function jt(o){const t=new Uint8Array(wt(o));let e=0;for(const n of o)t.set(n,e),e+=n.length;return t}async function yt(o){let t=[];for await(const e of o)t=t.concat(e);return t}class K{constructor(t,e){this.blockPosition=t,this.dataPosition=e}toString(){return`${this.blockPosition}:${this.dataPosition}`}compareTo(t){return this.blockPosition-t.blockPosition||this.dataPosition-t.dataPosition}}function P(o,t=0,e=!1){if(e)throw new Error("big-endian virtual file offsets not implemented");return new K(o[t+7]*1099511627776+o[t+6]*4294967296+o[t+5]*16777216+o[t+4]*65536+o[t+3]*256+o[t+2],o[t+1]<<8|o[t])}const _t=21578050;function xt(o,t){return o-o%t}function vt(o,t){return o-o%t+t}function It(o,t){return t-=1,[[0,0],[1+(o>>26),1+(t>>26)],[9+(o>>23),9+(t>>23)],[73+(o>>20),73+(t>>20)],[585+(o>>17),585+(t>>17)],[4681+(o>>14),4681+(t>>14)]]}class C extends Q{async lineCount(t,e){var n,s;return((s=(n=(await this.parse(e)).indices(t))==null?void 0:n.stats)==null?void 0:s.lineCount)||0}async _parse(t){const e=await this.filehandle.readFile(),n=new DataView(e.buffer);if(n.getUint32(0,!0)!==_t)throw new Error("Not a BAI file");const s=n.getInt32(4,!0),r=((1<<18)-1)/7;let i=8,a;const h=[];for(let l=0;l<s;l++){h.push(i);const f=n.getInt32(i,!0);i+=4;for(let p=0;p<f;p+=1){const w=n.getUint32(i,!0);if(i+=4,w===r+1)i+=4,i+=32;else{if(w>r+1)throw new Error("bai index contains too many bins, please use CSI");{const g=n.getInt32(i,!0);i+=4;for(let _=0;_<g;_++)i+=8,i+=8}}}const m=n.getInt32(i,!0);i+=4;const d=new Array(m);for(let p=0;p<m;p++){const w=P(e,i);i+=8,a=T(a,w),d[p]=w}}const c=new Y({maxSize:5});function u(l){let f=h[l];if(f===void 0)return;const m=n.getInt32(f,!0);let d;f+=4;const p={};for(let _=0;_<m;_+=1){const x=n.getUint32(f,!0);if(f+=4,x===r+1)f+=4,d=X(e,f+16),f+=32;else{if(x>r+1)throw new Error("bai index contains too many bins, please use CSI");{const I=n.getInt32(f,!0);f+=4;const S=new Array(I);for(let A=0;A<I;A++){const R=P(e,f);f+=8;const E=P(e,f);f+=8,a=T(a,R),S[A]=new L(R,E,x)}p[x]=S}}}const w=n.getInt32(f,!0);f+=4;const g=new Array(w);for(let _=0;_<w;_++){const x=P(e,f);f+=8,a=T(a,x),g[_]=x}return{binIndex:p,linearIndex:g,stats:d}}return{bai:!0,firstDataLine:a,maxBlockSize:65536,indices:l=>{if(!c.has(l)){const f=u(l);return f&&c.set(l,f),f}return c.get(l)},refCount:s}}async indexCov(t,e,n,s){const r=e!==void 0,i=(await this.parse(s)).indices(t);if(!i)return[];const{linearIndex:a=[],stats:h}=i;if(a.length===0)return[];const c=n===void 0?(a.length-1)*16384:vt(n,16384),u=e===void 0?0:xt(e,16384),l=r?new Array((c-u)/16384):new Array(a.length-1),f=a[a.length-1].blockPosition;if(c>(a.length-1)*16384)throw new Error("query outside of range of linear index");let m=a[u/16384].blockPosition;for(let d=u/16384,p=0;d<c/16384;d++,p++)l[p]={score:a[d+1].blockPosition-m,start:d*16384,end:d*16384+16384},m=a[d+1].blockPosition;return l.map(d=>({...d,score:d.score*((h==null?void 0:h.lineCount)||0)/f}))}async blocksForRange(t,e,n,s={}){e<0&&(e=0);const r=await this.parse(s);if(!r)return[];const i=r.indices(t);if(!i)return[];const a=It(e,n),h=[];for(const[m,d]of a)for(let p=m;p<=d;p++)if(i.binIndex[p]){const w=i.binIndex[p];for(const g of w)h.push(new L(g.minv,g.maxv,p))}const c=i.linearIndex.length;let u;const l=Math.min(e>>14,c-1),f=Math.min(n>>14,c-1);for(let m=l;m<=f;++m){const d=i.linearIndex[m];d&&(!u||d.compareTo(u)<0)&&(u=d)}return J(h,u)}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(t,e={}){var n;return!!((n=(await this.parse(e)).indices(t))!=null&&n.binIndex)}}const At=21582659,St=38359875;function Pt(o,t){return o*2**t}function j(o,t){return Math.floor(o/2**t)}class O extends Q{constructor(){super(...arguments),this.maxBinNumber=0,this.depth=0,this.minShift=0}async lineCount(t,e){var n,s;return((s=(n=(await this.parse(e)).indices(t))==null?void 0:n.stats)==null?void 0:s.lineCount)||0}async indexCov(){return[]}parseAuxData(t,e){const n=new DataView(t.buffer),s=n.getUint32(e,!0),r=s&65536?"zero-based-half-open":"1-based-closed",i={0:"generic",1:"SAM",2:"VCF"}[s&15];if(!i)throw new Error(`invalid Tabix preset format flags ${s}`);const a={ref:n.getInt32(e+4,!0),start:n.getInt32(e+8,!0),end:n.getInt32(e+12,!0)},h=n.getInt32(e+16,!0),c=h?String.fromCharCode(h):"",u=n.getInt32(e+20,!0),l=n.getInt32(e+24,!0);return{columnNumbers:a,coordinateType:r,metaValue:h,metaChar:c,skipLines:u,format:i,formatFlags:s,...bt(t.subarray(e+28,e+28+l),this.renameRefSeq)}}async _parse(t){const e=await this.filehandle.readFile(t),n=await $(e),s=new DataView(n.buffer);let r;const i=s.getUint32(0,!0);if(i===At)r=1;else if(i===St)r=2;else throw new Error(`Not a CSI file ${i}`);this.minShift=s.getInt32(4,!0),this.depth=s.getInt32(8,!0),this.maxBinNumber=((1<<(this.depth+1)*3)-1)/7;const a=this.maxBinNumber,h=s.getInt32(12,!0),c=h>=30?this.parseAuxData(n,16):void 0,u=s.getInt32(16+h,!0);let l=16+h+4,f;const m=[];for(let w=0;w<u;w++){m.push(l);const g=s.getInt32(l,!0);l+=4;for(let _=0;_<g;_++){const x=s.getUint32(l,!0);if(l+=4,x>this.maxBinNumber)l+=44;else{l+=8;const I=s.getInt32(l,!0);l+=4;for(let S=0;S<I;S+=1){const A=P(n,l);l+=8,l+=8,f=T(f,A)}}}}const d=new Y({maxSize:5});function p(w){let g=m[w];if(g===void 0)return;const _=s.getInt32(g,!0);g+=4;const x={};let I;for(let S=0;S<_;S++){const A=s.getUint32(g,!0);if(g+=4,A>a)I=X(n,g+28),g+=44;else{f=T(f,P(n,g)),g+=8;const R=s.getInt32(g,!0);g+=4;const E=new Array(R);for(let D=0;D<R;D+=1){const Z=P(n,g);g+=8;const tt=P(n,g);g+=8,E[D]=new L(Z,tt,A)}x[A]=E}}return{binIndex:x,stats:I}}return{csiVersion:r,firstDataLine:f,indices:w=>{if(!d.has(w)){const g=p(w);return g&&d.set(w,g),g}return d.get(w)},refCount:u,csi:!0,maxBlockSize:65536,...c}}async blocksForRange(t,e,n,s={}){e<0&&(e=0);const r=(await this.parse(s)).indices(t);if(!r)return[];const i=this.reg2bins(e,n);if(i.length===0)return[];const a=[];for(const[h,c]of i)for(let u=h;u<=c;u++)if(r.binIndex[u]){const l=r.binIndex[u];for(const f of l)a.push(f)}return J(a,new K(0,0))}reg2bins(t,e){t-=1,t<1&&(t=1),e>2**50&&(e=2**34),e-=1;let n=0,s=0,r=this.minShift+this.depth*3;const i=[];for(;n<=this.depth;r-=3,s+=Pt(1,n*3),n+=1){const a=s+j(t,r),h=s+j(e,r);if(h-a+i.length>this.maxBinNumber)throw new Error(`query ${t}-${e} is too large for current binning scheme (shift ${this.minShift}, depth ${this.depth}), try a smaller query or a coarser index binning scheme`);i.push([a,h])}return i}async parse(t={}){return this.setupP||(this.setupP=this._parse(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async hasRefSeq(t,e={}){var n;return!!((n=(await this.parse(e)).indices(t))!=null&&n.binIndex)}}class Rt{read(){throw new Error("never called")}stat(){throw new Error("never called")}readFile(){throw new Error("never called")}close(){throw new Error("never called")}}const v={BAM_FPAIRED:1,BAM_FPROPER_PAIR:2,BAM_FUNMAP:4,BAM_FMUNMAP:8,BAM_FREVERSE:16,BAM_FMREVERSE:32,BAM_FREAD1:64,BAM_FREAD2:128,BAM_FSECONDARY:256,BAM_FQCFAIL:512,BAM_FDUP:1024,BAM_FSUPPLEMENTARY:2048};var Ct=function(o,t,e,n,s){if(typeof t=="function"?o!==t||!0:!t.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(o,e),e},y=function(o,t,e,n){if(typeof t=="function"?o!==t||!n:!t.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(o):n?n.value:t.get(o)},b;const G="=ACMGRSVTWYHKDBN".split(""),F="MIDNSHP=X???????".split("");class M{constructor(t){b.set(this,void 0),this.bytes=t.bytes,this.fileOffset=t.fileOffset,Ct(this,b,new DataView(this.bytes.byteArray.buffer))}get byteArray(){return this.bytes.byteArray}get flags(){return(y(this,b,"f").getInt32(this.bytes.start+16,!0)&4294901760)>>16}get ref_id(){return y(this,b,"f").getInt32(this.bytes.start+4,!0)}get start(){return y(this,b,"f").getInt32(this.bytes.start+8,!0)}get end(){return this.start+this.length_on_ref}get id(){return this.fileOffset}get mq(){const t=(this.bin_mq_nl&65280)>>8;return t===255?void 0:t}get score(){return this.mq}get qual(){if(this.isSegmentUnmapped())return;const t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes;return this.byteArray.subarray(t,t+this.seq_length)}get strand(){return this.isReverseComplemented()?-1:1}get b0(){return this.bytes.start+36}get name(){let t="";for(let e=0;e<this.read_name_length-1;e++)t+=String.fromCharCode(this.byteArray[this.b0+e]);return t}get tags(){let t=this.b0+this.read_name_length+this.num_cigar_ops*4+this.num_seq_bytes+this.seq_length;const e=this.bytes.end,n={};for(;t<e;){const s=String.fromCharCode(this.byteArray[t],this.byteArray[t+1]),r=String.fromCharCode(this.byteArray[t+2]);if(t+=3,r==="A")n[s]=String.fromCharCode(this.byteArray[t]),t+=1;else if(r==="i")n[s]=y(this,b,"f").getInt32(t,!0),t+=4;else if(r==="I")n[s]=y(this,b,"f").getUint32(t,!0),t+=4;else if(r==="c")n[s]=y(this,b,"f").getInt8(t),t+=1;else if(r==="C")n[s]=y(this,b,"f").getUint8(t),t+=1;else if(r==="s")n[s]=y(this,b,"f").getInt16(t,!0),t+=2;else if(r==="S")n[s]=y(this,b,"f").getUint16(t,!0),t+=2;else if(r==="f")n[s]=y(this,b,"f").getFloat32(t,!0),t+=4;else if(r==="Z"||r==="H"){const i=[];for(;t<=e;){const a=this.byteArray[t++];if(a!==0)i.push(String.fromCharCode(a));else break}n[s]=i.join("")}else if(r==="B"){const i=this.byteArray[t++],a=String.fromCharCode(i),h=y(this,b,"f").getInt32(t,!0);if(t+=4,a==="i")if(s==="CG"){const c=[];for(let u=0;u<h;u++){const l=y(this,b,"f").getInt32(t,!0),f=l>>4,m=F[l&15];c.push(f+m),t+=4}n[s]=c.join("")}else{const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getInt32(t,!0)),t+=4;n[s]=c}else if(a==="I")if(s==="CG"){const c=[];for(let u=0;u<h;u++){const l=y(this,b,"f").getUint32(t,!0),f=l>>4,m=F[l&15];c.push(f+m),t+=4}n[s]=c.join("")}else{const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getUint32(t,!0)),t+=4;n[s]=c}else if(a==="s"){const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getInt16(t,!0)),t+=2;n[s]=c}else if(a==="S"){const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getUint16(t,!0)),t+=2;n[s]=c}else if(a==="c"){const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getInt8(t)),t+=1;n[s]=c}else if(a==="C"){const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getUint8(t)),t+=1;n[s]=c}else if(a==="f"){const c=[];for(let u=0;u<h;u++)c.push(y(this,b,"f").getFloat32(t,!0)),t+=4;n[s]=c}}else{console.error("Unknown BAM tag type",r);break}}return n}isPaired(){return!!(this.flags&v.BAM_FPAIRED)}isProperlyPaired(){return!!(this.flags&v.BAM_FPROPER_PAIR)}isSegmentUnmapped(){return!!(this.flags&v.BAM_FUNMAP)}isMateUnmapped(){return!!(this.flags&v.BAM_FMUNMAP)}isReverseComplemented(){return!!(this.flags&v.BAM_FREVERSE)}isMateReverseComplemented(){return!!(this.flags&v.BAM_FMREVERSE)}isRead1(){return!!(this.flags&v.BAM_FREAD1)}isRead2(){return!!(this.flags&v.BAM_FREAD2)}isSecondary(){return!!(this.flags&v.BAM_FSECONDARY)}isFailedQc(){return!!(this.flags&v.BAM_FQCFAIL)}isDuplicate(){return!!(this.flags&v.BAM_FDUP)}isSupplementary(){return!!(this.flags&v.BAM_FSUPPLEMENTARY)}get cigarAndLength(){if(this.isSegmentUnmapped())return{length_on_ref:0,CIGAR:""};const t=this.num_cigar_ops;let e=this.b0+this.read_name_length;const n=[];let s=y(this,b,"f").getInt32(e,!0),r=s>>4,i=F[s&15];if(i==="S"&&r===this.seq_length)return e+=4,s=y(this,b,"f").getInt32(e,!0),r=s>>4,i=F[s&15],i!=="N"&&console.warn("CG tag with no N tag"),{CIGAR:this.tags.CG,length_on_ref:r};{let a=0;for(let h=0;h<t;++h)s=y(this,b,"f").getInt32(e,!0),r=s>>4,i=F[s&15],n.push(r+i),i!=="H"&&i!=="S"&&i!=="I"&&(a+=r),e+=4;return{CIGAR:n.join(""),length_on_ref:a}}}get length_on_ref(){return this.cigarAndLength.length_on_ref}get CIGAR(){return this.cigarAndLength.CIGAR}get num_cigar_ops(){return this.flag_nc&65535}get read_name_length(){return this.bin_mq_nl&255}get num_seq_bytes(){return this.seq_length+1>>1}get seq(){const t=this.b0+this.read_name_length+this.num_cigar_ops*4,e=this.num_seq_bytes,n=this.seq_length,s=[];let r=0;for(let i=0;i<e;++i){const a=this.byteArray[t+i];s.push(G[(a&240)>>4]),r++,r<n&&(s.push(G[a&15]),r++)}return s.join("")}get pair_orientation(){if(!this.isSegmentUnmapped()&&!this.isMateUnmapped()&&this.ref_id===this.next_refid){const t=this.isReverseComplemented()?"R":"F",e=this.isMateReverseComplemented()?"R":"F";let n=" ",s=" ";this.isRead1()?(n="1",s="2"):this.isRead2()&&(n="2",s="1");const r=[];return this.template_length>0?(r[0]=t,r[1]=n,r[2]=e,r[3]=s):(r[2]=t,r[3]=n,r[0]=e,r[1]=s),r.join("")}}get bin_mq_nl(){return y(this,b,"f").getInt32(this.bytes.start+12,!0)}get flag_nc(){return y(this,b,"f").getInt32(this.bytes.start+16,!0)}get seq_length(){return y(this,b,"f").getInt32(this.bytes.start+20,!0)}get next_refid(){return y(this,b,"f").getInt32(this.bytes.start+24,!0)}get next_pos(){return y(this,b,"f").getInt32(this.bytes.start+28,!0)}get template_length(){return y(this,b,"f").getInt32(this.bytes.start+32,!0)}toJSON(){const t={};for(const e of Object.keys(this))e.startsWith("_")||e==="bytes"||(t[e]=this[e]);return t}}b=new WeakMap;function B(o,t){const e=Object.getOwnPropertyDescriptor(o.prototype,t);if(!e)throw new Error("OH NO, NO PROPERTY DESCRIPTOR");const n=e.get;if(!n)throw new Error("OH NO, NOT A GETTER");Object.defineProperty(o.prototype,t,{get(){const s=n.call(this);return Object.defineProperty(this,t,{value:s}),s}})}B(M,"tags");B(M,"cigarAndLength");B(M,"seq");B(M,"qual");function Ft(o){const t=o.split(/\r?\n/),e=[];for(const n of t){const[s,...r]=n.split(/\t/);s&&e.push({tag:s.slice(1),data:r.map(i=>{const a=i.indexOf(":"),h=i.slice(0,a),c=i.slice(a+1);return{tag:h,value:c}})})}return e}const Tt=21840194,Mt=65536;class Et{constructor({bamFilehandle:t,bamPath:e,bamUrl:n,baiPath:s,baiFilehandle:r,baiUrl:i,csiPath:a,csiFilehandle:h,csiUrl:c,htsget:u,yieldThreadTime:l=100,renameRefSeqs:f=m=>m}){if(this.htsget=!1,this.renameRefSeq=f,t)this.bam=t;else if(e)this.bam=new k(e);else if(n)this.bam=new q(n);else if(u)this.htsget=!0,this.bam=new Rt;else throw new Error("unable to initialize bam");if(h)this.index=new O({filehandle:h});else if(a)this.index=new O({filehandle:new k(a)});else if(c)this.index=new O({filehandle:new q(c)});else if(r)this.index=new C({filehandle:r});else if(s)this.index=new C({filehandle:new k(s)});else if(i)this.index=new C({filehandle:new q(i)});else if(e)this.index=new C({filehandle:new k(`${e}.bai`)});else if(n)this.index=new C({filehandle:new q(`${n}.bai`)});else if(u)this.htsget=!0;else throw new Error("unable to infer index format");this.yieldThreadTime=l}async getHeaderPre(t){const e=pt(t);if(!this.index)return;const n=await this.index.parse(e),s=n.firstDataLine?n.firstDataLine.blockPosition+65535:void 0;let r;if(s){const f=s+Mt;r=await this.bam.read(f,0)}else r=await this.bam.readFile(e);const i=await $(r),a=new DataView(i.buffer);if(a.getInt32(0,!0)!==Tt)throw new Error("Not a BAM file");const h=a.getInt32(4,!0),c=new TextDecoder("utf8");this.header=c.decode(i.subarray(8,8+h));const{chrToIndex:u,indexToChr:l}=await this._readRefSeqs(h+8,65535,e);return this.chrToIndex=u,this.indexToChr=l,Ft(this.header)}getHeader(t){return this.headerP||(this.headerP=this.getHeaderPre(t).catch(e=>{throw this.headerP=void 0,e})),this.headerP}async getHeaderText(t={}){return await this.getHeader(t),this.header}async _readRefSeqs(t,e,n){if(t>e)return this._readRefSeqs(t,e*2,n);const s=await this.bam.read(e,0,n),r=await $(s),i=new DataView(r.buffer),a=i.getInt32(t,!0);let h=t+4;const c={},u=[],l=new TextDecoder("utf8");for(let f=0;f<a;f+=1){const m=i.getInt32(h,!0),d=this.renameRefSeq(l.decode(r.subarray(h+4,h+4+m-1))),p=i.getInt32(h+m+4,!0);if(c[d]=f,u.push({refName:d,length:p}),h=h+8+m,h>r.length)return console.warn(`BAM header is very big.  Re-fetching ${e} bytes.`),this._readRefSeqs(t,e*2,n)}return{chrToIndex:c,indexToChr:u}}async getRecordsForRange(t,e,n,s){return yt(this.streamRecordsForRange(t,e,n,s))}async*streamRecordsForRange(t,e,n,s){var r;await this.getHeader(s);const i=(r=this.chrToIndex)==null?void 0:r[t];if(i===void 0||!this.index)yield[];else{const a=await this.index.blocksForRange(i,e-1,n,s);yield*this._fetchChunkFeatures(a,i,e,n,s)}}async*_fetchChunkFeatures(t,e,n,s,r={}){const{viewAsPairs:i}=r,a=[];let h=!1;for(const c of t){const{data:u,cpositions:l,dpositions:f}=await this._readChunk({chunk:c,opts:r}),m=await this.readBamFeatures(u,l,f,c),d=[];for(const p of m)if(p.ref_id===e)if(p.start>=s){h=!0;break}else p.end>=n&&d.push(p);if(a.push(d),yield d,h)break}gt(r.signal),i&&(yield this.fetchPairs(e,a,r))}async fetchPairs(t,e,n){const{pairAcrossChr:s,maxInsertSize:r=2e5}=n,i={},a={};e.map(l=>{const f={};for(const m of l){const d=m.name,p=m.id;f[d]||(f[d]=0),f[d]++,a[p]=1}for(const[m,d]of Object.entries(f))d===1&&(i[m]=!0)});const h=[];e.map(l=>{for(const f of l){const m=f.name,d=f.start,p=f.next_pos,w=f.next_refid;this.index&&i[m]&&(s||w===t&&Math.abs(d-p)<r)&&h.push(this.index.blocksForRange(w,p,p+1,n))}});const c=new Map,u=await Promise.all(h);for(const l of u.flat())c.has(l.toString())||c.set(l.toString(),l);return(await Promise.all([...c.values()].map(async l=>{const{data:f,cpositions:m,dpositions:d,chunk:p}=await this._readChunk({chunk:l,opts:n}),w=[];for(const g of await this.readBamFeatures(f,m,d,p))i[g.name]&&!a[g.id]&&w.push(g);return w}))).flat()}async _readChunk({chunk:t,opts:e}){const n=await this.bam.read(t.fetchedSize(),t.minv.blockPosition,e),{buffer:s,cpositions:r,dpositions:i}=await et(n,t);return{data:s,cpositions:r,dpositions:i,chunk:t}}async readBamFeatures(t,e,n,s){let r=0;const i=[];let a=0,h=+Date.now();const c=new DataView(t.buffer);for(;r+4<t.length;){const u=c.getInt32(r,!0),l=r+4+u-1;if(n){for(;r+s.minv.dataPosition>=n[a++];);a--}if(l<t.length){const f=new M({bytes:{byteArray:t,start:r,end:l},fileOffset:e.length>0?e[a]*256+(r-n[a])+s.minv.dataPosition+1:nt(t.subarray(r,l))>>>0});i.push(f),this.yieldThreadTime&&+Date.now()-h>this.yieldThreadTime&&(await dt(1),h=+Date.now())}r=l+1}return i}async hasRefSeq(t){var e,n;const s=(e=this.chrToIndex)==null?void 0:e[t];return s===void 0?!1:(n=this.index)==null?void 0:n.hasRefSeq(s)}async lineCount(t){var e;const n=(e=this.chrToIndex)==null?void 0:e[t];return n===void 0||!this.index?0:this.index.lineCount(n)}async indexCov(t,e,n){var s;if(!this.index)return[];await this.index.parse();const r=(s=this.chrToIndex)==null?void 0:s[t];return r===void 0?[]:this.index.indexCov(r,e,n)}async blocksForRange(t,e,n,s){var r;if(!this.index)return[];await this.index.parse();const i=(r=this.chrToIndex)==null?void 0:r[t];return i===void 0?[]:this.index.blocksForRange(i,e,n,s)}}class H{constructor(t,e,n){this.record=t,this.adapter=e,this.ref=n}id(){return`${this.adapter.id}-${this.record.id}`}get mismatches(){return ht(this.record.CIGAR,this.record.tags.MD,this.record.seq,this.ref,this.record.qual)}get qual(){var t;return(t=this.record.qual)===null||t===void 0?void 0:t.join(" ")}get(t){return t==="mismatches"?this.mismatches:t==="qual"?this.qual:this.fields[t]}parent(){}children(){}get fields(){const t=this.record,e=this.adapter,n=t.isPaired();return{start:t.start,name:t.name,end:t.end,score:t.score,strand:t.strand,template_length:t.template_length,flags:t.flags,tags:t.tags,refName:e.refIdToName(t.ref_id),CIGAR:t.CIGAR,seq:t.seq,type:"match",pair_orientation:t.pair_orientation,next_ref:n?e.refIdToName(t.next_refid):void 0,next_pos:n?t.next_pos:void 0,next_segment_position:n?`${e.refIdToName(t.next_refid)}:${t.next_pos+1}`:void 0,uniqueId:this.id()}}toJSON(){return{...this.fields,qual:this.qual}}}W(H,"fields");W(H,"mismatches");class qt extends st.BaseFeatureDataAdapter{constructor(){super(...arguments),this.ultraLongFeatureCache=new ct({maxSize:500})}async configurePre(){const t=this.getConf("bamLocation"),e=this.getConf(["index","location"]),n=this.getConf(["index","indexType"]),s=this.pluginManager,r=n==="CSI",i=new Et({bamFilehandle:U.openLocation(t,s),csiFilehandle:r?U.openLocation(e,s):void 0,baiFilehandle:r?void 0:U.openLocation(e,s),yieldThreadTime:Number.POSITIVE_INFINITY}),a=this.getConf("sequenceAdapter");if(a&&this.getSubAdapter){const{dataAdapter:h}=await this.getSubAdapter(a);return{bam:i,sequenceAdapter:h}}return{bam:i}}async configure(){return this.configureP||(this.configureP=this.configurePre().catch(t=>{throw this.configureP=void 0,t})),this.configureP}async getHeader(t){const{bam:e}=await this.configure();return e.getHeaderText()}async setupPre(t){const{bam:e}=await this.configure(),n=await e.getHeader(),s=[],r={};if(n)for(const[i,a]of n.filter(h=>h.tag==="SQ").entries()){const h=a.data.find(c=>c.tag==="SN");if(h){const c=h.value;r[c]=i,s[i]=c}}return this.samHeader={idToName:s,nameToId:r},this.samHeader}async setupPre2(t){return this.setupP||(this.setupP=this.setupPre(t).catch(e=>{throw this.setupP=void 0,e})),this.setupP}async setup(t){const{statusCallback:e=()=>{}}=t||{};return N.updateStatus("Downloading index",e,()=>this.setupPre2(t))}async getRefNames(t){const{idToName:e}=await this.setup(t);return e}async seqFetch(t,e,n){const{sequenceAdapter:s}=await this.configure(),r=s;if(!r||!t)return;const i=r.getFeatures({refName:t,start:e,end:n,assemblyName:""}),a=await rt(i.pipe(it()));let h="";for(const c of a.sort((u,l)=>u.get("start")-l.get("start"))){const u=c.get("start"),l=c.get("end"),f=Math.max(e-u,0),m=Math.min(n-u,l-u)-f,d=c.get("seq")||c.get("residues");h+=d.slice(f,f+m)}if(h.length!==n-e)throw new Error(`sequence fetch failed: fetching ${t}:${(e-1).toLocaleString()}-${n.toLocaleString()} returned ${h.length.toLocaleString()} bases, but should have returned ${(n-e).toLocaleString()}`);return h}getFeatures(t,e){const{refName:n,start:s,end:r,originalRefName:i}=t,{stopToken:a,filterBy:h,statusCallback:c=()=>{}}=e||{};return ut.ObservableCreate(async u=>{const{bam:l}=await this.configure();await this.setup(e),z.checkStopToken(a);const f=await N.updateStatus("Downloading alignments",c,()=>l.getRecordsForRange(n,s,r));z.checkStopToken(a),await N.updateStatus("Processing alignments",c,async()=>{const{flagInclude:m=0,flagExclude:d=0,tagFilter:p,readName:w}=h||{};for(const g of f){let _;if(g.tags.MD||(_=await this.seqFetch(i||n,g.start,g.end)),ot(g.flags,m,d)||p&&at(g.tags[p.tag],p.value)||w&&g.name!==w)continue;const x=this.ultraLongFeatureCache.get(`${g.id}`);if(x)u.next(x);else{const I=new H(g,this,_);this.ultraLongFeatureCache.set(`${g.id}`,I),u.next(I)}}u.complete()})})}async getMultiRegionFeatureDensityStats(t,e){const{bam:n}=await this.configure();if(n.index){const s=await N.bytesForRegions(t,n),r=this.getConf("fetchSizeLimit");return{bytes:s,fetchSizeLimit:r}}return super.getMultiRegionFeatureDensityStats(t,e)}refIdToName(t){var e;return(e=this.samHeader)===null||e===void 0?void 0:e.idToName[t]}}const Gt=Object.freeze(Object.defineProperty({__proto__:null,default:qt},Symbol.toStringTag,{value:"Module"}));export{Et as B,Tt as a,qt as b,jt as c,Gt as d,Ft as p};
