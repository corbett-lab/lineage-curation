import{f as g}from"./main-D1zX1xg0-CI_PM91Q.js";import{Q as w,q as M}from"./index-BvvsWeUy-CPrgRp4B.js";import{e as b}from"./index-Bp4pXTEU-Cipcrd2k.js";import{a1 as f,u as y}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{o as F}from"./rxjs-euq-mp90-DvajfGj-.js";import{x as T}from"./parseLineByLine-Be3SOOi9-j_LJE5Tt.js";import"./index-Bwk-R6QR.js";import"./taxonium-component.es-D8UFPkMd.js";function L(u,e=()=>{}){const t=[],a={};return T.parseLineByLine(u,r=>{if(r.startsWith("#"))t.push(r);else{const n=r.indexOf("	"),s=r.slice(0,n);a[s]||(a[s]=[]),a[s].push(r)}return!0},e),{header:t.join(`
`),featureMap:a}}class x extends b.BaseFeatureDataAdapter{constructor(){super(...arguments),this.calculatedIntervalTreeMap={}}async getHeader(){const{header:e}=await this.setup();return e}async getMetadata(){const{parser:e}=await this.setup();return e.getMetadata()}async setupP(e){const{statusCallback:t=()=>{}}=e||{},a=f.openLocation(this.getConf("vcfLocation"),this.pluginManager),r=await y.fetchAndMaybeUnzip(a,e),{header:n,featureMap:s}=L(r,t),c=new w({header:n}),o=Object.fromEntries(Object.entries(s).map(([i,m])=>[i,l=>{if(!this.calculatedIntervalTreeMap[i]){l==null||l("Parsing VCF data");let d=0;const h=new g;for(const v of m){const p=new M({variant:c.parseLine(v),parser:c,id:`${this.id}-${i}-${d++}`});h.insert([p.get("start"),p.get("end")],p)}this.calculatedIntervalTreeMap[i]=h}return this.calculatedIntervalTreeMap[i]}]));return{header:n,parser:c,intervalTreeMap:o}}async setup(){return this.vcfFeatures||(this.vcfFeatures=this.setupP().catch(e=>{throw this.vcfFeatures=void 0,e})),this.vcfFeatures}async getRefNames(e={}){const{intervalTreeMap:t}=await this.setup();return Object.keys(t)}getFeatures(e,t={}){return F.ObservableCreate(async a=>{var r;try{const{start:n,end:s,refName:c}=e,{intervalTreeMap:o}=await this.setup();for(const i of((r=o[c])===null||r===void 0?void 0:r.call(o,t.statusCallback).search([n,s]))||[])a.next(i);a.complete()}catch(n){a.error(n)}},t.stopToken)}async getSources(){const e=this.getConf("samplesTsvLocation");if(e.uri===""||e.uri==="/path/to/samples.tsv"){const{parser:t}=await this.setup();return t.samples.map(a=>({name:a}))}else{const t=(await f.openLocation(e).readFile("utf8")).split(/\n|\r\n|\r/),a=t[0].split("	"),{parser:r}=await this.setup(),n=new Set(r.samples);return t.slice(1).map(s=>{const c=s.split("	");return{name:c[0],...Object.fromEntries(c.slice(1).map((o,i)=>[a[i+1],o]))}}).filter(s=>n.has(s.name))}}}x.capabilities=["getFeatures","getRefNames"];export{x as default};
