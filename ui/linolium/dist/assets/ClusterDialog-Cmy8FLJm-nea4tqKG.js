import{r as i,j as e}from"./index-Bwk-R6QR.js";import{o as R,a as S,D as L,B as d,O as F,d as T,u as p,t as q,j as D,T as A,m as P,P as H,aM as B,aN as J,c as N}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{E as O}from"./RadioGroup-o1e9QUFF-BonhG3v5.js";import{F as I}from"./FormControlLabel-t1db3bCW-BhUWxcLA.js";import{R as V}from"./Radio-Cp2Uq8Z1-VQbIOt0f.js";import"./taxonium-component.es-D8UFPkMd.js";const Q=R(function({model:s,children:r,handleClose:o}){const[u,h]=i.useState(""),[x,a]=i.useState(!1),[m,f]=i.useState(),[g,C]=i.useState("");return e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[r,e.jsxs("div",{children:[x?e.jsxs("div",{style:{padding:50},children:[e.jsx("span",{children:u||"Loading..."}),e.jsx(d,{onClick:()=>{F.stopStopToken(g)},children:"Stop"})]}):null,m?e.jsx(S.ErrorMessage,{error:m}):null]})]}),e.jsxs(T,{children:[e.jsx(d,{variant:"contained",disabled:x,onClick:async()=>{try{f(void 0),h("Initializing"),a(!0);const l=p.getContainingView(s);if(!l.initialized)return;const{rpcManager:j}=p.getSession(s),{sourcesWithoutLayout:v,minorAlleleFrequencyFilter:b,lengthCutoffFilter:M,adapterConfig:y}=s;if(v){const k=q.getRpcSessionId(s),t=F.createStopToken();C(t);const n=await j.call(k,"MultiVariantClusterGenotypeMatrix",{regions:l.dynamicBlocks.contentBlocks,sources:v,minorAlleleFrequencyFilter:b,lengthCutoffFilter:M,sessionId:k,adapterConfig:y,stopToken:t,statusCallback:c=>{h(c)}});s.setLayout(n.order.map(c=>{const w=v[c];if(!w)throw new Error(`out of bounds at ${c}`);return w}))}o()}catch(l){!p.isAbortException(l)&&D(s)&&(console.error(l),f(l))}finally{a(!1),h(""),C("")}},children:"Run clustering"}),e.jsx(d,{variant:"contained",color:"secondary",onClick:()=>{o(),g&&F.stopStopToken(g)},children:"Cancel"})]})]})}),X=P()(s=>({textAreaFont:{fontFamily:"Courier New"},mgap:{display:"flex",flexDirection:"column",gap:s.spacing(4)}})),Y=R(function({model:s,handleClose:r,children:o}){const{classes:u}=X(),[h,x]=i.useState(""),[a,m]=i.useState(),[f,g]=i.useState(),[C,l]=i.useState(!1),[j,v]=p.useLocalStorage("cluster-showAdvanced",!1),[b,M]=i.useState("single");i.useEffect(()=>{(async()=>{try{g(void 0),m(void 0),l(!0);const t=p.getContainingView(s);if(!t.initialized)return;const{rpcManager:n}=p.getSession(s),{sourcesWithoutLayout:c,minorAlleleFrequencyFilter:w,lengthCutoffFilter:W,adapterConfig:z}=s,E=q.getRpcSessionId(s),G=await n.call(E,"MultiVariantGetGenotypeMatrix",{regions:t.dynamicBlocks.contentBlocks,sources:c,minorAlleleFrequencyFilter:w,lengthCutoffFilter:W,sessionId:E,adapterConfig:z});m(G)}catch(t){!p.isAbortException(t)&&D(s)&&(console.error(t),g(t))}finally{l(!1)}})()},[s]);const y=a?`inputMatrix<-matrix(c(${Object.values(a).map(t=>t.join(",")).join(`,
`)}
),nrow=${Object.values(a).length},byrow=TRUE)
rownames(inputMatrix)<-c(${Object.keys(a).map(t=>`'${t}'`).join(",")})
resultClusters<-hclust(dist(inputMatrix), method='${b}')
cat(resultClusters$order,sep='\\n')`:void 0,k=a?Object.entries(a).map(([t,n])=>[t,...n].join("	")).join(`
`):void 0;return e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[o,e.jsxs(H,{style:{padding:16},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap",marginBottom:"16px"},children:[e.jsx(d,{variant:"contained",onClick:()=>{B.saveAs(new Blob([y||""],{type:"text/plain;charset=utf-8"}),"cluster.R")},children:"Download Rscript"})," ","or"," ",e.jsx(d,{variant:"contained",onClick:()=>{J(y||"")},children:"Copy Rscript to clipboard"})," ","or"," ",e.jsx(d,{variant:"contained",onClick:()=>{B.saveAs(new Blob([k||""],{type:"text/plain;charset=utf-8"}),"genotypes.tsv")},children:"Download TSV"}),e.jsx("div",{children:e.jsx(d,{variant:"contained",onClick:()=>{v(!j)},children:j?"Hide advanced options":"Show advanced options"})})]}),j?e.jsxs("div",{children:[e.jsx(A,{variant:"h6",children:"Advanced options"}),e.jsx(O,{children:Object.entries({single:"Single",complete:"Complete"}).map(([t,n])=>e.jsx(I,{control:e.jsx(V,{checked:b===t,onChange:()=>{M(t)}}),label:n},t))})]}):null,y?e.jsx("div",{}):C?e.jsx(S.LoadingEllipses,{variant:"h6",title:"Generating genotype matrix"}):f?e.jsx(S.ErrorMessage,{error:f}):null]}),e.jsxs("div",{children:[e.jsx(A,{variant:"subtitle2",gutterBottom:!0,style:{marginTop:"16px"},children:"Clustering Results:"}),e.jsx(N,{multiline:!0,fullWidth:!0,variant:"outlined",placeholder:"Paste results from Rscript here (sequence of numbers, one per line, specifying the new ordering)",rows:10,value:h,onChange:t=>{x(t.target.value)},slotProps:{input:{classes:{input:u.textAreaFont}}}})]})]})]}),e.jsxs(T,{children:[e.jsx(d,{variant:"contained",onClick:()=>{const{sourcesWithoutLayout:t}=s;if(t)try{s.setLayout(h.split(`
`).map(n=>n.trim()).filter(n=>!!n).map(n=>+n).map(n=>{const c=t[n-1];if(!c)throw new Error(`out of bounds at ${n}`);return c}))}catch(n){console.error(n),p.getSession(s).notifyError(`${n}`,n)}r()},children:"Apply clustering"}),e.jsx(d,{variant:"contained",color:"secondary",onClick:()=>{r()},children:"Cancel"})]})]})});function $({activeMode:s,setActiveMode:r}){return e.jsxs("div",{children:[e.jsx(A,{style:{marginBottom:30},children:"This procedure will cluster the visible genotype data using hierarchical clustering"}),e.jsx(O,{children:Object.entries({auto:e.jsx("div",{children:"Run in-app clustering (slower, particularly for large numbers of samples, uses JS implementation of hclust)"}),manual:e.jsx("div",{children:"Download R script to run clustering (faster, uses R implementation of hclust)"})}).map(([o,u])=>e.jsx(I,{control:e.jsx(V,{checked:s===o,onChange:()=>{r(o)}}),label:u},o))})]})}const se=R(function({model:s,handleClose:r}){const[o,u]=i.useState("auto");return e.jsx(S.Dialog,{open:!0,title:"Cluster by genotype",onClose:(h,x)=>{x!=="backdropClick"&&r()},children:o==="auto"?e.jsx(Q,{model:s,handleClose:r,children:e.jsx($,{activeMode:o,setActiveMode:u})}):e.jsx(Y,{model:s,handleClose:r,children:e.jsx($,{activeMode:o,setActiveMode:u})})})});export{se as default};
