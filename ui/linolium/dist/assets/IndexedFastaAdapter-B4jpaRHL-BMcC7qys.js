import{c as _}from"./AbortablePromiseCache-CcuMrnn7-56xRj2xE.js";import"./unzip-CwWdnRSo-02Ze3MCz.js";import{r as u}from"./browser-BpRiKmO--zAOSyNoU.js";import{e as v}from"./index-Bp4pXTEU-Cipcrd2k.js";import{a1 as h,u as x,O}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{s as I}from"./QuickLRU-Bsq1VS-k-DOcaC3o-.js";import{o as L}from"./rxjs-euq-mp90-DvajfGj-.js";import"./index-CJFOLICt-oWu2Snlz.js";import"./taxonium-component.es-D8UFPkMd.js";import"./index-Bwk-R6QR.js";function q(r,e){return r.offset+r.lineBytes*Math.floor(e/r.lineLength)+e%r.lineLength}async function j(r,e={}){const a=new TextDecoder("utf8");return Object.fromEntries(a.decode(await r.readFile(e)).split(/\r?\n/).map(t=>t.trim()).filter(t=>!!t).map(t=>t.split("	")).map(t=>{var s;if((s=t[0])!=null&&s.startsWith(">"))throw new Error("found > in sequence name, might have supplied FASTA file for the FASTA index");return[t[0],{name:t[0],length:+t[1],start:0,end:+t[1],offset:+t[2],lineLength:+t[3],lineBytes:+t[4]}]}))}class E{constructor({fasta:e,fai:a,path:t,faiPath:s}){if(e)this.fasta=e;else if(t)this.fasta=new u(t);else throw new Error("Need to pass filehandle for fasta or path to localfile");if(a)this.fai=a;else if(s)this.fai=new u(s);else if(t)this.fai=new u(`${t}.fai`);else throw new Error("Need to pass filehandle for  or path to localfile")}async _getIndexes(e){return this.indexes||(this.indexes=j(this.fai,e).catch(a=>{throw this.indexes=void 0,a})),this.indexes}async getSequenceNames(e){return Object.keys(await this._getIndexes(e))}async getSequenceSizes(e){const a={},t=await this._getIndexes(e);for(const s of Object.values(t))a[s.name]=s.length;return a}async getSequenceSize(e,a){var t;return(t=(await this._getIndexes(a))[e])==null?void 0:t.length}async hasReferenceSequence(e,a){return!!(await this._getIndexes(a))[e]}async getResiduesByName(e,a,t,s){const n=(await this._getIndexes(s))[e];return n?this._fetchFromIndexEntry(n,a,t,s):void 0}async getSequence(e,a,t,s){return this.getResiduesByName(e,a,t,s)}async _fetchFromIndexEntry(e,a=0,t,s){let n=t;if(a<0)throw new TypeError("regionStart cannot be less than 0");if((n===void 0||n>e.length)&&(n=e.length),a>=n)return"";const i=q(e,a),o=q(e,n)-i;return new TextDecoder("utf8").decode(await this.fasta.read(o,i,s)).replace(/\s+/g,"")}}class F extends v.BaseSequenceAdapter{constructor(){super(...arguments),this.seqCache=new _({cache:new I({maxSize:200}),fill:async e=>{const{refName:a,start:t,end:s,fasta:n}=e;return n.getSequence(a,t,s)}})}async getRefNames(e){const{fasta:a}=await this.setup();return a.getSequenceNames()}async getRegions(e){const{fasta:a}=await this.setup(),t=await a.getSequenceSizes();return Object.keys(t).map(s=>({refName:s,start:0,end:t[s]}))}async setupPre(){const e=this.getConf("fastaLocation"),a=this.getConf("faiLocation");return{fasta:new E({fasta:h.openLocation(e,this.pluginManager),fai:h.openLocation(a,this.pluginManager)})}}async getHeader(){const e=this.getConf("metadataLocation");return e.uri===""||e.uri==="/path/to/fa.metadata.yaml"?null:h.openLocation(e,this.pluginManager).readFile("utf8")}async setup(){return this.setupP||(this.setupP=this.setupPre().catch(e=>{throw this.setupP=void 0,e})),this.setupP}getFeatures(e,a){const{statusCallback:t=()=>{},stopToken:s}=a||{},{refName:n,start:i,end:o}=e;return L.ObservableCreate(async l=>{await x.updateStatus2("Downloading sequence",t,s,async()=>{const{fasta:d}=await this.setup(),b=await d.getSequenceSize(n),p=Math.min(b||0,o),g=[],f=128e3,m=i-i%f,N=o+(f-o%f);for(let c=m;c<N;c+=f){const y={refName:n,start:c,end:c+f};O.checkStopToken(s);const S=await this.seqCache.get(JSON.stringify(y),{...y,fasta:d});if(!S)break;g.push(S)}const w=g.filter(c=>!!c).join("").slice(i-m).slice(0,o-i);w&&l.next(new x.SimpleFeature({id:`${n}-${i}-${p}`,data:{refName:n,start:i,end:p,seq:w}}))}),l.complete()})}}const D=Object.freeze(Object.defineProperty({__proto__:null,default:F},Symbol.toStringTag,{value:"Module"}));export{E as I,F as a,D as b};
