import{s as d,be as o}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";import{e as p}from"./index-Bp4pXTEU-Cipcrd2k.js";import{c as f}from"./crc32-CxoSWZf_-CJxmRem5.js";import{K as g}from"./taxonium-component.es-D8UFPkMd.js";import"./index-Bwk-R6QR.js";const i=(c,t)=>g.from(c,t);function w(c,t){const a=(s,e)=>t(i(s),e)>>>0;return a.signed=(s,e)=>t(i(s),e),a.unsigned=a,a.model=c,a}const x=w("crc-32",f);class y{constructor(t){this.url=t.url.endsWith("/")?t.url:`${t.url}/`}async readMeta(){const t=await this.loadFile("meta.json"),{compress:a,track_names:s}=t;return{hashHexCharacters:Math.ceil(t.hash_bits/4),compress:a,tracks:s}}async getHashHexCharacters(){return(await this.readMeta()).hashHexCharacters}async getCompress(){return(await this.readMeta()).compress}async getTrackNames(){return(await this.readMeta()).tracks}async get(t){return(await this.getBucket(t))[t]}async getBucket(t){const a=this.hash(t),s=await this.hexToDirPath(a);return this.loadFile(s)}async loadFile(t){const a=await fetch(`${this.url}${t}`);if(!a.ok)throw new Error(`HTTP ${a.status} ${a.statusText}`);return a.json()}async hexToDirPath(t){const a=await this.getHashHexCharacters();if(a){const s=await this.getCompress();for(;t.length<8;)t=`0${t}`;t=t.slice(8-a);const e=[];for(let r=0;r<t.length;r+=3)e.push(t.slice(r,r+3));return`${e.join("/")}.json${s?"z":""}`}return""}hash(t){return x(t).toString(16).toLowerCase().replace("-","n")}}class M extends p.BaseAdapter{constructor(t,a,s){super(t,a,s);const e=d.readConfObject(t,"namesIndexLocation"),{baseUri:r,uri:n}=e;this.httpMap=new y({url:r?new URL(n,r).href:n})}async loadIndexFile(t){return this.httpMap.getBucket(t)}async searchIndex(t){const{searchType:a,queryString:s}=t,e=this.tracksNames||await this.httpMap.getTrackNames(),r=s.toLowerCase(),n=await this.loadIndexFile(r);return n[r]?this.formatResults(n[r],e,a):[]}formatResults(t,a,s){return[...s==="exact"?[]:t.prefix.map(e=>new o({label:typeof e=="object"?e.name:e,matchedAttribute:"name",matchedObject:{result:e}})),...t.exact.map(e=>{const r=e[0],n=e[1],h=e[3],u=e[4],l=e[5],m=`${h||r}:${u}-${l}`;return new o({locString:m,label:r,matchedAttribute:"name",matchedObject:e,trackId:a[n]})})].filter(e=>e.getLabel()!=="too many matches")}}export{M as default};
