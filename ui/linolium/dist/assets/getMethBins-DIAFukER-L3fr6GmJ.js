import{br as P,bs as E,u as N,bq as R}from"./JBrowsePanel-CjeUdi3D-Dhrr89W5.js";function v(n,s){let e=0,o=0,t=0;const f=[];for(let c=0;c<n.length&&t<s.length;c+=2){const l=+n[c],r=n[c+1];if(r==="S"||r==="I"){for(let i=0;i<l&&t<s.length;i++)s[t]===e+i&&t++;e+=l}else if(r==="D"||r==="N")o+=l;else if(r==="M"||r==="X"||r==="="){for(let i=0;i<l&&t<s.length;i++)s[t]===e+i&&(f.push({ref:o+i,idx:t}),t++);e+=l,o+=l}}return f}function w(n,s,e){const o=e===-1?N.revcom(s):s,t=n.split(";"),f=[];for(const c of t){if(c==="")continue;const l=c.split(","),r=l[0],i=R.exec(r);if(!i)throw new Error(`bad format for MM tag: "${c}"`);const[,u,a,d]=i,b=d.split(/(\d+|.)/);a==="-"&&(console.warn("unsupported negative strand modifications"),f.push({type:"unsupported",positions:[],base:u,strand:a}));for(const p of b){if(p==="")continue;let h=0;const M=[];for(let g=1,y=l.length;g<y;g++){let x=+l[g];do(u==="N"||u===o[h])&&x--,h++;while(x>=0&&h<o.length);if(e===-1){const m=o.length-h;m>=0&&M.unshift(m)}else M.push(h-1)}f.push({type:p,base:u,strand:a,positions:M})}}return f}function q(n){const s=P(n,"ML","Ml")||[];if(s){const e=[];if(typeof s=="string"){const o=s.split(",");for(let t=0,f=o.length;t<f;t++)e.push(+o[t]/255)}else for(let o=0,t=s.length;o<t;o++)e.push(s[o]/255);return e}else{const e=P(n,"MP","Mp");if(e){const o=[];for(let t=0,f=e.length;t<f;t++){const c=e.charCodeAt(t)-33;o.push(Math.min(1,c/50))}return o}return}}function B(n,s){const e=n.get("strand"),o=n.get("seq"),t=P(n,"MM","Mm")||"",f=s||E(n.get("CIGAR"));if(o){const c=w(t,o,e),l=q(n),r=[];let i=0;for(const{type:u,positions:a}of c){for(const{ref:d,idx:b}of v(f,a)){const p=(l==null?void 0:l[i+(e===-1?a.length-1-b:b)])||0;if(!r[d])r[d]={type:u,prob:p,allProbs:[p]};else{const h=r[d];r[d]={allProbs:[...h.allProbs,p],prob:Math.max(h.prob,p),type:h.prob>p?h.type:u}}}i+=a.length}return r}}function C(n,s){const e=n.get("start"),o=n.get("end"),t=n.get("strand"),f=o-e,c=P(n,"MM","Mm")||"",l=[],r=[],i=[],u=[],a=n.get("seq");if(a){const d=q(n),b=w(c,a,t);let p=0;for(const{type:h,positions:M}of b){for(const{ref:g,idx:y}of v(s,M)){if(g<0||g>=f)continue;const x=p+(t===-1?M.length-1-y:y),m=(d==null?void 0:d[x])||0;h==="m"?(l[g]=1,i[g]=m):h==="h"&&(r[g]=1,u[g]=m)}p+=M.length}}return{methBins:l,hydroxyMethBins:r,methProbs:i,hydroxyMethProbs:u}}export{B as E,C as N};
